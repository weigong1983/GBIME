/*****************************************************************************
*  Copyright Statement:
*  --------------------
*
* Filename:
* ---------
*    CLayoutAbstract.c
*
* Project:
* --------
*   Guobi Input Method
*
* Description:
* ------------
*
* Author:
* -------
* -------
***********************************************************************/
#include "CLayoutAbstract.h"
#include "GB_Global.h"

#define GBIME_SYMBOL_0_ROW_NUM				2
#define GBIME_SYMBOL_1_ROW_NUM				2
#define GBIME_MULTITAP_SYMBOLS_0 			L" \n"

GBIMELOCAL GBIMEReturn CLayoutAbstract__Init(PCLayoutAbstract pltDest);
GBIMELOCAL void CLayoutAbstract__InitVariable(GBLPVOID pltObj);
GBIMELOCAL GBIMEReturn CLayoutAbstract__ReleaseBase(GBLPVOID pltObj, PLayoutInfo pltUIData);
GBIMELOCAL GBIMEReturn CLayoutAbstract__SetRefreshFlag(GBLPVOID pltObj, GBUINT refreshFlag);
GBIMELOCAL GBIMEReturn CLayoutAbstract__Paint(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo);
//GBIMELOCAL GBIMEReturn CLayoutAbstract__PreHandleEvent(GBLPVOID pltObj, GBINT nPlatformEvent, GBINT wParam, GBINT lParam, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL PenPosition CLayoutAbstract__PenPositionInKeyboardButton(GBLPVOID pltObj, GBIMEPoint hitPoint, 
																	ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL PenPosition CLayoutAbstract__HitTest(GBLPVOID pltObj, GBIMEPoint hitPoint, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract__HandleCommonEvent(GBLPVOID pltObj, PGBIMEEvent pIMEEvent, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract__ResetEventGroup(GBLPVOID pltObj);
GBIMELOCAL GBIMEReturn CLayoutAbstract__FillEventGroup(GBLPVOID pltObj, GBIMEConvertTypeEnum convertType, GBINT wParam, GBINT lParam);
GBIMELOCAL PGBIMEEventGroup CLayoutAbstract__GetIMEEventGroup(GBLPVOID pltObj);
GBIMELOCAL GBIMEReturn CLayoutAbstract__HandleEvent(GBLPVOID pltObj, PGBIMEEvent pIMEEvent, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract__SetConfig(void);
GBIMELOCAL GBIMEReturn CLayoutAbstract__SetInputMethod(void);
GBIMELOCAL GBIMEReturn CLayoutAbstract__Listenner(void);
GBIMELOCAL GBIMEReturn CLayoutAbstract__IsMatchLtObjAndLtID(GBLPVOID pltObj, GBUINT16 ltID);
GBIMELOCAL GBIMEReturn CLayoutAbstract__IsNeedLeave(GBLPVOID pltObj);
GBIMELOCAL GBIMEReturn CLayoutAbstract__ChangeHeight(GBLPVOID pltObj, GBINT newHeight);
GBIMELOCAL GBIMEReturn CLayoutAbstract__UpScreen(GBLPVOID pltObj, GBPCWCHAR pCand);
GBIMELOCAL GBIMEReturn CLayoutAbstract__Redraw(GBLPVOID pltObj);
GBIMELOCAL GBUINT16 CLayoutAbstract_GetLayoutHeight(GBLPVOID pltObj, LayoutIdEnum layoutId);
GBIMELOCAL GBUINT16 CLayoutAbstract_GetLayoutWidth(GBLPVOID pltObj, LayoutIdEnum layoutId);
GBIMELOCAL GBBOOL CLayoutAbstract_GetBottonRectByKey(GBLPVOID pltObj,LayoutIdEnum layoutId,
								  LayerIndex layerId, GBUINT16 iKeyValue, PGBRECT pRect);
GBIMELOCAL PLAYOUTCONSTLAYER CLayoutAbstract_GetLayerConstInfo(GBLPVOID pltObj, LayoutIdEnum layoutId, LayerIndex layerId);
GBIMELOCAL PBUTTONCONSTDATA CLayoutAbstract_GetLayerConstButtons(GBLPVOID pltObj, LayoutIdEnum layoutId, LayerIndex layerId);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SwitchHandler(GBLPVOID pltObj);
GBIMELOCAL GBIMEReturn CLayoutAbstract_FuncKeyHandler(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo);
//GBIMELOCAL GBIMEReturn CLayoutAbstract_PhysicFuncKeyHandler(GBLPVOID pltObj, GBINT nPlatformEvent, GBINT wParam, GBINT lParam, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SwitchPreLayoutObj(GBLPVOID pltObj);
GBIMELOCAL GBINT16 CLayoutAbstract_GetCandidateBoxHeight(GBLPVOID pltObj, LayoutIdEnum layoutId, LayerIndex layerId);
GBIMELOCAL void CLayoutAbstract_GetWinPos(GBLPVOID pltObj, PGBIMEPoint pWinPos);
GBIMELOCAL void CLayoutAbstract_GetLayoutWinRect(GBLPVOID pltObj, PGBRECT pLayoutWinRect);
GBIMELOCAL void CLayoutAbstract_GetLayoutStartPoint(GBLPVOID pltObj, PGBIMEPoint startPoint);
GBIMELOCAL void CLayoutAbstract_SetSyllableDisplayStartPos(GBLPVOID pltObj, GBINT16 x, GBINT16 y);
GBIMELOCAL void CLayoutAbstract_SetCandidateDisplayStartPos(GBLPVOID pltObj, GBINT16 x, GBINT16 y);
GBIMELOCAL GBBOOL CLayoutAbstract_IsInputKey(GBUINT16 keyValue);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SlidingPenDownHandler(GBLPVOID pltObj, GBIMEPoint pt);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SlidingPenUpHandler(GBLPVOID pltObj, GBIMEPoint pt);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SlidingPenMoveHandler(GBLPVOID pltObj, GBIMEPoint pt);
GBIMELOCAL GBIMEReturn CLayoutAbstract_LongPressKeyHandler(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL void CLayoutAbstract_DeleteAll(void);
GBIMELOCAL GBIMEReturn CLayoutAbstract_ShowCandWin(GBLPVOID pltObj, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract_ShowAssociateWin(GBLPVOID pltObj, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract_CloseCandWin(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract_CheckUpScreen(GBLPVOID pltObj, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract_MultiTapSymbolHandler(GBLPVOID pltObj);
GBIMELOCAL GBIMEReturn CLayoutAbstract_MultiTapFaceHandler(GBLPVOID pltObj);
GBIMELOCAL void CLayoutAbstract_OnMultitapTimer(void);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SwitchShiftCapStatus(GBLPVOID pltObj, GBShiftCapStatus shiftCapStatus, GBBOOL bAuto,	PEngineOutputInfo pEngineOutputInfo);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SyncEngineShiftCapStatus(GBLPVOID pltObj);
GBIMELOCAL void CLayoutAbstract_KBMultiTapTimerCallBack(void);
GBIMELOCAL GBIMEReturn CLayoutAbstract_SetInterpunctionKey(GBLPVOID pltObj);
GBIMELOCAL GBIMEReturn CLayoutAbstract_DisableFuncKeyHandler(GBLPVOID pltObj);


GBIMEGLOBAL CLayoutAbstract * CLayoutAbstract__Construct(PCLayoutAbstract pltDest, 
											 GBLPCVOID pcltUIData,
											 GBLPCVOID pcltIMData,
											 GBLPCVOID hcltImage)
{
	memset(pltDest, 0, sizeof(CLayoutAbstract));
	pltDest->m_ltType = CLayoutInfo_GetLayoutTypeFromLtData(pcltUIData);
	pltDest->m_ltData.pltcData = pcltUIData;
	pltDest->m_pltIMData = pcltIMData;
	Global_SetLayoutWinWidth(PT_GetLcdWidth());
	Global_SetLayoutWinHeight(0);
	pltDest->m_refreshFlag = GBIME_LAYOUT_REFRESH_NONE;

	CLayoutInfo_LayoutInitData(&pltDest->m_ltData, pcltUIData);

	CLayoutAbstract__Init(pltDest);

	return pltDest;
}


GBIMELOCAL GBIMEReturn CLayoutAbstract__Init(PCLayoutAbstract pltDest)
{
	//pltDest->m_pfcInit = CLayoutAbstract__Init;
	pltDest->m_pfcInitVariable = CLayoutAbstract__InitVariable;
	pltDest->m_pfcRelease = CLayoutAbstract__ReleaseBase;	//È±Ê¡
	pltDest->m_pfcReleaseBase = CLayoutAbstract__ReleaseBase;
	pltDest->m_pfcSetRefreshFlag = CLayoutAbstract__SetRefreshFlag;
	pltDest->m_pfcPaint = CLayoutAbstract__Paint;
	//pltDest->m_pfcPreHandleEvent = CLayoutAbstract__PreHandleEvent; // VKÖØÔØ
	pltDest->m_pfcPenPositionInKeyboardButton = CLayoutAbstract__PenPositionInKeyboardButton;
	pltDest->m_pfcHitTest = CLayoutAbstract__HitTest;
	pltDest->m_pfcHandleCommonEvent = CLayoutAbstract__HandleCommonEvent;
	//pltDest->m_pfcDispatchEvent = CLayoutAbstract__DispatchEvent;
	pltDest->m_pfcHandleEvent = CLayoutAbstract__HandleEvent;	
	pltDest->m_pfcSetConfig = CLayoutAbstract__SetConfig;
	pltDest->m_pfcSetIM = CLayoutAbstract__SetInputMethod;
	pltDest->m_pfcListenner = CLayoutAbstract__Listenner;
	pltDest->m_pfcIsMatchLtObjAndLtID = CLayoutAbstract__IsMatchLtObjAndLtID;
	pltDest->m_pfcIsNeedLeave = CLayoutAbstract__IsNeedLeave;	
	pltDest->m_pfcChangeHeight = CLayoutAbstract__ChangeHeight;
	pltDest->m_pfcUpScreen = CLayoutAbstract__UpScreen;
	pltDest->m_pfcRedraw = CLayoutAbstract__Redraw;
	pltDest->m_pfcGetLayoutHeight = CLayoutAbstract_GetLayoutHeight;
	pltDest->m_pfcGetLayoutWidth = CLayoutAbstract_GetLayoutWidth;
	pltDest->m_pfcGetBottonRectByKey = CLayoutAbstract_GetBottonRectByKey;
	pltDest->m_pfcGetLayerConstInfo = CLayoutAbstract_GetLayerConstInfo;
	pltDest->m_pfcGetLayerConstButtons = CLayoutAbstract_GetLayerConstButtons;
	pltDest->m_pfcSwitchHandler = CLayoutAbstract_SwitchHandler;
	pltDest->m_pfcFuncKeyHandler = CLayoutAbstract_FuncKeyHandler;
	//pltDest->m_pfcPhysicFuncKeyHandler = CLayoutAbstract_PhysicFuncKeyHandler; // VKÖØÔØ
	pltDest->m_pfcLongPressKeyHandler = CLayoutAbstract_LongPressKeyHandler;
	pltDest->m_pfcSwitchPreLayoutObj = CLayoutAbstract_SwitchPreLayoutObj;
	pltDest->m_pfcGetCandidateBoxHeight = CLayoutAbstract_GetCandidateBoxHeight;
	pltDest->m_pfcGetWinPos = CLayoutAbstract_GetWinPos;
	pltDest->m_pfcGetLayoutWinRect = CLayoutAbstract_GetLayoutWinRect;
	pltDest->m_pfcGetLayoutStartPoint = CLayoutAbstract_GetLayoutStartPoint;
	pltDest->m_pfcSetSyllableDisplayStartPos = CLayoutAbstract_SetSyllableDisplayStartPos;
	pltDest->m_pfcSetCandidateDisplayStartPos = CLayoutAbstract_SetCandidateDisplayStartPos;
	pltDest->m_pfcIsInputKey = CLayoutAbstract_IsInputKey;	
	pltDest->m_pfcSlidingPenDownHandler = CLayoutAbstract_SlidingPenDownHandler;
	pltDest->m_pfcSlidingPenUpHandler = CLayoutAbstract_SlidingPenUpHandler;
	pltDest->m_pfcSlidingPenMoveHandler = CLayoutAbstract_SlidingPenMoveHandler;
	pltDest->m_pfcShowCandWin = CLayoutAbstract_ShowCandWin;
	pltDest->m_pfcShowAssociateWin = CLayoutAbstract_ShowAssociateWin;
	pltDest->m_pfcCloseCandWin = CLayoutAbstract_CloseCandWin;
	pltDest->m_pfcCheckUpScreen = CLayoutAbstract_CheckUpScreen;
	pltDest->m_pfcMultiTapSymbolHandler = CLayoutAbstract_MultiTapSymbolHandler;
	pltDest->m_pfcMultiTapFaceHandler = CLayoutAbstract_MultiTapFaceHandler;
	pltDest->m_pfcOnMultitapTimer = CLayoutAbstract_OnMultitapTimer;
	pltDest->m_pfcSwitchShiftCapStatus = CLayoutAbstract_SwitchShiftCapStatus;
	pltDest->m_pfcSyncEngineShiftCapStatus = CLayoutAbstract_SyncEngineShiftCapStatus;
	pltDest->m_pfcKBMultiTapTimerCallBack = CLayoutAbstract_KBMultiTapTimerCallBack;
	pltDest->m_pfcSetInterpunctionKey = CLayoutAbstract_SetInterpunctionKey;
	pltDest->m_pfcDisableFuncKeyHandler = CLayoutAbstract_DisableFuncKeyHandler;
	pltDest->lastUseTime = 0;

	return GBIME_OK;
}

/*!
 * \brief ³õÊ¼»¯LayoutÏà¹Ø±äÁ¿
 * \param pltObj 
 * \return 
 * \note 
 *\example
 * \author weizhiping
 * \date 2010-10-29 15:06:27
 */
GBIMELOCAL void CLayoutAbstract__InitVariable(GBLPVOID pltObj)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;

	// »¬ÆÁ½á¹¹Ìå
	memset(&pltAbstractObj->slidingOperation, 0, sizeof(SlidingOperation));
	pltAbstractObj->isSlidingDisabled = GBFalse;

	/*!
	 * \brief Layout Ë¢ÐÂÏÔÊ¾¼°ÏûÏ¢´¦ÀíÏà¹Ø±äÁ¿
	 */
	pltAbstractObj->m_refreshFlag = GBIME_LAYOUT_REFRESH_NONE;
	memset(&pltAbstractObj->syllableDisplayStartPos, 0, sizeof(GBIMEPoint));///<Òô½ÚÀ¸ÆðÊ¼ÏÔÊ¾Î»ÖÃ	
	memset(&pltAbstractObj->candidateDisplayStartPos, 0, sizeof(GBIMEPoint));///<ºòÑ¡À¸ÆðÊ¼ÏÔÊ¾Î»ÖÃ	
	pltAbstractObj->pressLayoutKeyValue = 0;///<¼ÇÂ¼°´ÏÂÊ±µÄLayout°´¼üÖµ(Ö»ÓÐµ±°´ÏÂºÍµ¯Æð¼üÖµÒ»ÖÂÊ±²ÅÖ´ÐÐ°´¼ü²Ù×÷)
	pltAbstractObj->currentLayoutKeyValue = 0;///<µ±Ç°µãÖÐµÄ°´¼ü¶ÔÓ¦¼üÖµ
	pltAbstractObj->currentSyllableIndex = 0;///<µ±Ç°Ñ¡ÖÐµÄÒô½ÚË÷Òý
	pltAbstractObj->currentCandidateIndex = 0;///<µ±Ç°Ñ¡ÖÐµÄºòÑ¡Ë÷Òý
	pltAbstractObj->penDownPostion = PenPositionInNothing;///<´¥Ãþ±Ê°´ÏÂµÄÎ»ÖÃ
	pltAbstractObj->penInPostion = PenPositionInNothing;///<µ±Ç°µãÖÐµÄÎ»ÖÃ
	pltAbstractObj->buttonStatus = ButtonStatusNomal;///<°´Å¥×´Ì¬

	/*!
	 * \brief Multitap·ûºÅ¹¦ÄÜÏà¹Ø±äÁ¿
	 * note: Çå³ýMultiTap×´Ì¬Ö®Ç°±ØÐëÏÈÖØÖÃµ±Ç°LayoutµÄMultiTap¶¨Ê±Æ÷, È¡Ïû¸ßÁÁÏÔÊ¾
	 */
	if (pltAbstractObj->m_pfcKBMultiTapTimerCallBack != NULL)
	{
		pltAbstractObj->m_pfcKBMultiTapTimerCallBack();
	}
	if (pltAbstractObj->m_pfcOnMultitapTimer != NULL)
	{
		pltAbstractObj->m_pfcOnMultitapTimer();
	}

	pltAbstractObj->bMultitapTimerStartFlag = GBFalse;///<MultiTap¶¨Ê±Æ÷Æô¶¯±ê¼Ç
	pltAbstractObj->bMultitapSymbolStartFlag = GBFalse;///<MultiTap·ûºÅÆô¶¯±ê¼Ç
	pltAbstractObj->bMultitapFaceStartFlag = GBFalse;///<MultiTap±íÇéÆô¶¯±ê¼Ç
	pltAbstractObj->multitapReplaceCandLength = 0;///<¸ßÁÁÌæ»»ºòÑ¡×Ö·û³¤¶È
	pltAbstractObj->multitapCandIndex = 0;///<MultitapºòÑ¡·ûºÅµ±Ç°Ë÷Òý

	/*!
	 * \brief GBV5ÒýÇæ½»»¥Ïà¹Ø±äÁ¿
	 */
	pltAbstractObj->bSendEngineKeyEvent = GBFalse;///<ÊÇ·ñÐèÒª·¢ËÍÒýÇæ°´¼üÊÂ¼þ 
	pltAbstractObj->engineKeyEvent = GBEvent_None;///<¾­¹ýLayoutÔ¤´¦ÀíÖ®ºó×ª»»ºóµÄÒýÇæ°´¼üÊÂ¼þ
	pltAbstractObj->engineEventParam = 0;///<¾­¹ýLayoutÔ¤´¦ÀíÖ®ºó×ª»»ºóµÄÒýÇæÊÂ¼þ²ÎÊý
	pltAbstractObj->bUpToInputKeySequence = GBFalse;///<Êý×ÖÉÏÆÁ±ê¼Ç
}

GBIMELOCAL GBIMEReturn CLayoutAbstract__ReleaseBase(GBLPVOID pltObj, PLayoutInfo pltUIData)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;

	CLayoutInfo_LayoutReleaseData(pltUIData);

	if (pltAbstractObj != NULL)
	{
		if (pltAbstractObj->m_hltView != NULL)
		{
			PT_Free(pltAbstractObj->m_hltView);
			pltAbstractObj->m_hltView = NULL;
		}
		
		if (pltAbstractObj->pSymbolChineseString != NULL)
		{
			PT_Free(pltAbstractObj->pSymbolChineseString);
			pltAbstractObj->pSymbolChineseString = NULL;
		}
		if (pltAbstractObj->pSymbolEnglishString != NULL)
		{
			PT_Free(pltAbstractObj->pSymbolEnglishString);
			pltAbstractObj->pSymbolEnglishString = NULL;
		}
		if (pltAbstractObj->pFaceString != NULL)
		{
			PT_Free(pltAbstractObj->pFaceString);
			pltAbstractObj->pFaceString = NULL;
		}
		//¸Ã´¦²»ÄÜÊÍ·Å£¬ÍâÃæÓÐÓÃµ½ Zhaokun
// 		PT_Free(pltAbstractObj);
// 		pltAbstractObj = NULL;

		pltAbstractObj->lastUseTime = 0;
	}
	

	return GBIME_OK;
}

/*!
 * \brief ÉèÖÃLayoutÏÔÊ¾Ãæ°åµÄË¢ÐÂ±ê¼Ç£¬±ÜÃâÎÞÐ§Ë¢ÐÂ£¬Ìá¸ßË¢ÐÂËÙ¶È
 * \param pltObj 
 * \param refreshFlag 
 * \return 
 * \note 
 *\example
 * \author weizhiping
 * \date 2010-7-27 15:15:47
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract__SetRefreshFlag(GBLPVOID pltObj, GBUINT refreshFlag)
{
	PCLayoutAbstract pltTempObj = (PCLayoutAbstract)pltObj;
	PT_Assert(pltTempObj);
	pltTempObj->m_refreshFlag |= refreshFlag;
	return GBIME_OK;
}

GBIMELOCAL GBIMEReturn CLayoutAbstract__Paint(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo)
{
	return GBIME_OK;
}

/*!
 * \brief ÅÐ¶Ïµ±Ç°´¥Ãþ±ÊÊÇ·ñµã»÷ÔÚ¼üÅÌ°´Å¥ÉÏ
 * \param pltObj 
 * \param hitPoint 
 * \param buttonStatus 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-8-17 16:48:11
*/
GBIMELOCAL PenPosition CLayoutAbstract__PenPositionInKeyboardButton(GBLPVOID pltObj, 
																	GBIMEPoint hitPoint, 
																	ButtonStatusEnum buttonStatus,
																	PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
    GBUINT16 iCandidateBoxHeight = 0;
	GBUINT16 iKeyBoardHeight = 0;
	PenPosition penPositionInWhere = PenPositionInNothing;
	GBUINT16 iCurrentLayoutId;

	//µ±Ç°ÒªÏÔÊ¾µÄ²ã
	GBUINT16 iCurrentLayerNumber;
	GBUINT16 iButtonTotalCount;
	GBUINT16 iCount;
	GBUINT16 iEngineKeyValue;
	//GBINT32 left,top,right,buttom;
	GBIMEPoint winPos;
	GBRECT buttonPos;
	PLayoutChgtLayer pLayoutChgtLayer;

	// µ±Ç°LayoutId
	iCurrentLayoutId = GET_LAYOUT_ID(pltAbstractObj);
	// »ñÈ¡¼üÅÌ¸ß¶È
	iKeyBoardHeight = pltAbstractObj->m_pfcGetLayoutHeight(pltObj,iCurrentLayoutId);
	// È¡µÃ¼üÅÌÏÔÊ¾µÄ¿ªÊ¼Î»ÖÃ¡¾×óÏÂ½Ç¡¿£¬²¢µ÷ÕûÎª¡¾×óÉÏ½Ç¡¿
	Global_GetWinPos(&winPos);	
	winPos.y -=  iKeyBoardHeight;
	// µ±Ç°ÒªÏÔÊ¾µÄ²ã
	iCurrentLayerNumber = GET_LAYOUT_CURRENT_LAYER(pltAbstractObj);
	// È¡ºòÑ¡¿ò¸ß¶È
	iCandidateBoxHeight = pltAbstractObj->m_pfcGetCandidateBoxHeight(pltObj,iCurrentLayoutId,iCurrentLayerNumber);
	//ÏÈ²éµÚµØ²ã
	pLayoutChgtLayer = (PLayoutChgtLayer)&(pltAbstractObj->m_ltData.pltLayerData[FirstLayer]);

	// µÚÒ»£¬¶þ»òÈý²ãÊ±£¬¶¼»á²éÑ¯¼üÅÌ
	iButtonTotalCount = pLayoutChgtLayer->lyBtCount;

	// Ä¬ÈÏÎªÎÞÐ§µã»÷Î»ÖÃ
	pltAbstractObj->penInPostion = PenPositionInNothing;

	// ²éÑ¯Ã¿Ò»¸ö°´Å¥
	for (iCount = 0; iCount < iButtonTotalCount; iCount++)
	{
		// »ñÈ¡µ±Ç°°´Å¥Î»ÖÃ²¢×ª»»ÎªÆÁÄ»Ïà¶Ô×ø±ê
		buttonPos = pLayoutChgtLayer->plycBtData[iCount].btPos;
		buttonPos.top += winPos.y;
		buttonPos.bottom += winPos.y;

		if (PT_PointIsInRect(hitPoint, buttonPos))
		{
			// µã»÷»ÒÉ«½ûÓÃ°´Å¥£¬²Ù×÷ÎÞÐ§
			if (pLayoutChgtLayer->plyBtChgData[iCount].btStatus == ButtonStatusGray)
			{
				return pltAbstractObj->penInPostion;
			}

			// °´¼ü°´ÏÂ×´Ì¬[·´ÏÔÊ¾ÓÃ]
			pLayoutChgtLayer->plyBtChgData[iCount].btStatus = buttonStatus;			
			
			// °´µ½¼üÅÌµÄ°´Å¥ÉÏ
			penPositionInWhere = PenPositionInKeyboardButton;
			pltAbstractObj->buttonStatus = buttonStatus; // ¼ÇÂ¼°´Å¥×´Ì¬
			pltAbstractObj->penInPostion = penPositionInWhere;

			// ¼ÇÂ¼°´ÏÂÊ±µÄLayout°´¼üÖµ(Ö»ÓÐµ±°´ÏÂºÍµ¯Æð¼üÖµÒ»ÖÂÊ±²ÅÖ´ÐÐ°´¼ü²Ù×÷)
			if (buttonStatus == ButtonStatusDown)
			{
				pltAbstractObj->penDownPostion = PenPositionInKeyboardButton;
				pltAbstractObj->pressLayoutKeyValue = pLayoutChgtLayer->plycBtData[iCount].btKey;
			}

			// È¡µÃµ±Ç°°´Å¥¼üÖµ
			pltAbstractObj->currentLayoutKeyValue = pLayoutChgtLayer->plycBtData[iCount].btKey;
			// ×ª»¯ÎªÒýÇæ¼üÖµ
			iEngineKeyValue = CLayoutInfo_ConversionLayoutKeyToEngineKey(pltAbstractObj->currentLayoutKeyValue);
			break;
		}
	}

	// Àë¿ª¼üÅÌ
	if (iCount == iButtonTotalCount
		&& pltAbstractObj->penDownPostion == PenPositionInKeyboardButton)
	{
		// ¼ÇÂ¼°´Å¥×´Ì¬
		pltAbstractObj->buttonStatus = buttonStatus;
		// ¼ÇÂ¼µãÖÐµÄÎ»ÖÃ
		penPositionInWhere = pltAbstractObj->penInPostion = PenPositionLeave;			
		// ¼ÇÂ¼µãÖÐµÄºòÑ¡Ë÷ÒýÖµ
		pltAbstractObj->currentLayoutKeyValue = GBEvent_None;
	}
	
	//Èç¹ûÊÇµÚ¶þ»òµÚÈý²ãÊ±£¬»¹ÐèÒª²éµãÖÐµÄÊÇ·ñÊÇµÚ¶þ»òµÚÈý²ãµÄ·ÇºòÑ¡Çø°´Å¥
	if (iCurrentLayerNumber == SecondLayer || iCurrentLayerNumber == ThirdLayer)
	{
		//ÏÈ²éµÚµØ²ã
		pLayoutChgtLayer = (PLayoutChgtLayer)&(pltAbstractObj->m_ltData.pltLayerData[iCurrentLayerNumber]);
		//¶þ»òÈý²ãÊ±£¬¶¼»á²éÑ¯¼üÅÌ
		iButtonTotalCount = pLayoutChgtLayer->lyBtCount;
		
		// ²éÑ¯Ã¿Ò»¸ö°´Å¥
		for (iCount = 0; iCount < iButtonTotalCount; iCount++)
		{
			//Èç¹ûÊÇµÚ¶þ»òµÚÈý²ãµÄ·ÇºòÑ¡Çø°´Å¥
			if (pLayoutChgtLayer->plycBtData[iCount].btPos.bottom > iCandidateBoxHeight)
			{
				// »ñÈ¡µ±Ç°°´Å¥Î»ÖÃ²¢×ª»»ÎªÆÁÄ»Ïà¶Ô×ø±ê
				buttonPos = pLayoutChgtLayer->plycBtData[iCount].btPos;
				buttonPos.top += (winPos.y - iCandidateBoxHeight);
				buttonPos.bottom += (winPos.y - iCandidateBoxHeight);
				//Èç¹ûµãÖÐÁËµÚ¶þ»òµÚÈý²ãµÄ·ÇºòÑ¡Çø°´Å¥
				if (PT_PointIsInRect(hitPoint, buttonPos))
				{
					// °´¼ü°´ÏÂ×´Ì¬[·´ÏÔÊ¾ÓÃ]
					pLayoutChgtLayer->plyBtChgData[iCount].btStatus = buttonStatus;			
					
					// °´µ½¼üÅÌµÄ°´Å¥ÉÏ
					penPositionInWhere = PenPositionInKeyboardButton;
					pltAbstractObj->penInPostion = penPositionInWhere;
					pltAbstractObj->buttonStatus = buttonStatus; // ¼ÇÂ¼°´Å¥×´Ì¬

					// ¼ÇÂ¼°´ÏÂÊ±µÄLayout°´¼üÖµ(Ö»ÓÐµ±°´ÏÂºÍµ¯Æð¼üÖµÒ»ÖÂÊ±²ÅÖ´ÐÐ°´¼ü²Ù×÷)
					if (buttonStatus == ButtonStatusDown)
					{
						pltAbstractObj->pressLayoutKeyValue = pLayoutChgtLayer->plycBtData[iCount].btKey;
					}

					// È¡µÃµ±Ç°°´Å¥¼üÖµ
					pltAbstractObj->currentLayoutKeyValue = pLayoutChgtLayer->plycBtData[iCount].btKey;
					// ×ª»¯ÎªÒýÇæ¼üÖµ
					iEngineKeyValue = CLayoutInfo_ConversionLayoutKeyToEngineKey(pltAbstractObj->currentLayoutKeyValue);
					break;
				}
			}
		}
	}

	return pltAbstractObj->penInPostion;
}

/*!
 * \brief »ñÈ¡µ±Ç°´¥Ãþ±Ê°´ÏÂÊ±µÄÎ»ÖÃ£ºÔÚºòÑ¡ÉÏ£¬ÔÚ¼üÅÌ°´Å¥ÉÏ£¬ÆäËûµØ·½
 * \param pltObj 
 * \param hitPoint 
 * \param buttonStatus 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-8-17 16:48:11
*/
GBIMELOCAL PenPosition CLayoutAbstract__HitTest(GBLPVOID pltObj, GBIMEPoint hitPoint, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo)
{
	return PenPositionInNothing;
}

/*!
 * \brief Layout¹«¹²ÏûÏ¢´¦Àíº¯Êý(Íê³ÉÒ»Ð©¹«¹²µÄÍ¨ÓÃÏûÏ¢´¦Àí)
 * \param pltObj 
 * \param pIMEEvent 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-9-17 10:47:49
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract__HandleCommonEvent(GBLPVOID pltObj, PGBIMEEvent pIMEEvent, PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBIMEReturn ret = GBIME_OK;
	GBUINT16 nCurrentLayoutID = GET_LAYOUT_ID(pltAbstractObj);

	switch (pIMEEvent->nEvent)
	{
	case GBIME_EVENT_LAYOUT_ACTIVATE: ///<Layout ¼¤»î
		pltAbstractObj->m_ltData.ltCurLayer = FirstLayer;
		Global_SetLayoutWinActiveStatus(GBTrue);
		// ÎïÀí¼üÅÌÊ×´Î¼¤»î²»ÏÔÊ¾
		if (IS_KB_LAYOUT(nCurrentLayoutID))
		{
			Global_SetLayoutWinHeight(0);
		} 
		else // ÐéÄâ¼üÅÌÊ×´Î¼¤»îÏÔÊ¾¼üÅÌ
		{
			Global_SetLayoutWinHeight(pltAbstractObj->m_pfcGetLayoutHeight(pltObj, nCurrentLayoutID));
		}
	
		// ¸ù¾ÝÆ½Ì¨ÊäÈëÄ£Ê½¾ö¶¨ÊÇ·ñ½ûÓÃÄ³Ð©¹¦ÄÜ°´Å¥
		pltAbstractObj->m_pfcDisableFuncKeyHandler(pltObj);

		pltAbstractObj->m_refreshFlag = GBIME_LAYOUT_REFRESH_ALL;
		break;
	case GBIME_EVENT_LAYOUT_DEACTIVATE: ///<Layout ×¢Ïú
		pltAbstractObj->m_ltData.ltCurLayer = FirstLayer;
		Global_SetLayoutWinActiveStatus(GBFalse);
		Global_SetLayoutWinHeight(0);
		// ÖØÐÂ³õÊ¼»¯Layout¶ÔÏó×´Ì¬±äÁ¿
		pltAbstractObj->m_pfcInitVariable(pltObj);
		break;
	case GBIME_EVENT_LAYOUT_HIDE: ///<Layout Òþ²Ø
		pltAbstractObj->m_ltData.ltCurLayer = FirstLayer;
		Global_SetLayoutWinActiveStatus(GBFalse);
		pltAbstractObj->m_pfcChangeHeight(pltObj, 0);
		// ÖØÐÂ³õÊ¼»¯Layout¶ÔÏó×´Ì¬±äÁ¿
		pltAbstractObj->m_pfcInitVariable(pltObj);
		break;
	case GBIME_EVENT_LAYOUT_SHOW: ///<Layout ÏÔÊ¾
		pltAbstractObj->m_ltData.ltCurLayer = FirstLayer;
		Global_SetLayoutWinActiveStatus(GBTrue);
		// ÎïÀí¼üÅÌ²»ÏÔÊ¾
		if (IS_KB_LAYOUT(nCurrentLayoutID))
		{
			pltAbstractObj->m_pfcChangeHeight(pltObj, 0);
		} 
		else
		{
			pltAbstractObj->m_pfcChangeHeight(pltObj, pltAbstractObj->m_pfcGetLayoutHeight(pltObj, nCurrentLayoutID));
		}		
		pltAbstractObj->m_refreshFlag = GBIME_LAYOUT_REFRESH_ALL;
		break;
	case GBIME_EVENT_LAYOUT_ENTER:
		pltAbstractObj->m_ltData.ltCurLayer = FirstLayer;
		//Global_SetLayoutWinHeight(0); // ¸ß¶ÈÇåÁã£¬½â¾öLayout¼äÇÐ»»ÓÉÓÚ¸ß¶ÈÒ»ÑùÃ»ÓÐË¢ÐÂVK
		pltAbstractObj->m_pfcChangeHeight(pltObj, pltAbstractObj->m_pfcGetLayoutHeight(pltObj, nCurrentLayoutID));
		pltAbstractObj->m_refreshFlag = GBIME_LAYOUT_REFRESH_ALL;
		//pltAbstractObj->m_pfcInitVariable(pltObj);
		// ¸ù¾ÝÆ½Ì¨ÊäÈëÄ£Ê½¾ö¶¨ÊÇ·ñ½ûÓÃÄ³Ð©¹¦ÄÜ°´Å¥
		pltAbstractObj->m_pfcDisableFuncKeyHandler(pltObj);
		break;
	case GBIME_EVENT_LAYOUT_EXIT:
		Global_SetLayoutWinHeight(0); // ¸ß¶ÈÇåÁã£¬½â¾öLayout¼äÇÐ»»ÓÉÓÚ¸ß¶ÈÒ»ÑùÃ»ÓÐË¢ÐÂVK
		pltAbstractObj->m_pfcInitVariable(pltObj);
		break;
// 	case GBIME_EVENT_LAYOUT_SWITCH_OK:
// 		if (pltAbstractObj->bReuseInputStringFlag)
// 		{
// 			pltAbstractObj->m_pfcShowCandWin(pltObj, ButtonStatusUp, pEngineOutputInfo);
// 			GBEngine_SetInputString(Global_GetEnineInstance(), pltAbstractObj->backupEngineInputString);
// 			pltAbstractObj->m_refreshFlag = GBIME_LAYOUT_REFRESH_ALL;
// 			pltAbstractObj->bReuseInputStringFlag = GBFalse;
// 			pltAbstractObj->backupEngineInputString[0] = 0;
// 		}
// 		break;
	default:
		ret = GBIME_IGNORE;
		break;
	}
	
	return ret;
}

GBIMELOCAL GBIMEReturn CLayoutAbstract__HandleEvent(GBLPVOID pltObj, PGBIMEEvent pIMEEvent, PEngineOutputInfo pEngineOutputInfo)
{
	return GBIME_OK;
}

GBIMELOCAL GBIMEReturn CLayoutAbstract__SetConfig(void)
{

	return GBIME_OK;
}

GBIMELOCAL GBIMEReturn CLayoutAbstract__SetInputMethod(void)
{

	return GBIME_OK;
}


GBIMELOCAL GBIMEReturn CLayoutAbstract__Listenner(void)
{

	return GBIME_OK;
}

/*!
 *-brief Layout ¶ÔÏóÊÇ·ñºÍLayout IDÆ¥Åä
 *-return Æ¥Åä·µ»Ø1£¬²»Æ¥Åä·µ»Ø-1
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract__IsMatchLtObjAndLtID(GBLPVOID pltObj, GBUINT16 ltID)
{
	PCLayoutAbstract pltTempObj = pltObj;

	if (pltTempObj->m_ltData.pltcData->ltID == ltID)
	{
		return 1;
	}
	return 0;
}

/*!
 *-brief ÊÇ·ñÐèÒª±£ÁôLayout ¶ÔÏó
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract__IsNeedLeave(GBLPVOID pltObj)
{
	PCLayoutAbstract pltTempObj = pltObj;
	//if (LayoutVKSign == pltTempObj->m_ltData.pltcData->ltType)
	{
		return 1;
	}
	//return 0;
}


/*!
 * \brief ¸Ä±äLayout´°¿Ú¸ß¶È, ÐèÒªÍ¨ÖªÆ½Ì¨ÊäÈë¿òµ÷ÕûÄÚÈÝÇøµÄ¸ß¶È
 * \param pltObj 
 * \param newHeight 
 * \return 
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract__ChangeHeight(GBLPVOID pltObj, GBINT newHeight)
{
	PCLayoutAbstract pCLayoutAbstract = (PCLayoutAbstract)pltObj;

	// ±ÜÃâÆµ·±µ÷Õû¸ß¶È½µµÍË¢ÐÂÐ§ÂÊ
 	if (Global_GetLayoutWinHeight() == newHeight)
 	{
 		return GBIME_OK;
 	}

	// ¸üÐÂLayout´°¿ÚÏÔÊ¾¸ß¶È
	Global_SetLayoutWinHeight(newHeight);

	// ¸ù¾Ý´«Èë¸ß¶ÈÏÔÊ¾/Òþ²Ø¹ú±ÊÊäÈë·¨¿ò¼ÜÐéÄâ¼üÅÌ
	if (newHeight > 0)
	{
		GBInputBox_ShowVirtualKeyboard();
	} 
	else
	{
		GBInputBox_HideVirtualKeyboard();
	}

	return GBIME_OK;
}

/*!
 * \brief LayoutÉÏÆÁºòÑ¡
 * \param pltObj 
 * \param pCand 
 * \return 
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract__UpScreen(GBLPVOID pltObj, GBPCWCHAR pCand)
{
	GBInputBox_UpScreenString(pCand);	
	return GBIME_OK;
}

/*!
 * \brief Layout Í¨Öª±à¼­¿òÖØ»æ
 * \param pltObj 
 * \param pCand 
 * \return 
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract__Redraw(GBLPVOID pltObj)
{
	GBInputBox_Redraw();	
	return GBIME_OK;
}

/*!
 * \brief È¡µÃºòÑ¡¿òÍ¼µÄ¸ß¶È[ºòÑ¡¿òÒ²ÊÇÒ»¸ölayout]
 * \param layoutId 
 * \return ºòÑ¡¿òÍ¼µÄ¸ß¶È
 * \autor huanjin
 * \data 2010-8-26
 */
GBIMELOCAL GBUINT16 CLayoutAbstract_GetLayoutHeight(GBLPVOID pltObj, LayoutIdEnum layoutId)
{
	GBLPCVOID pSkinData = Global_GetSkinData();
	pltObj = pltObj;

	return CLayoutInfo_GetLayoutHeight(pSkinData, (GBUINT16)layoutId);
}

/*!
 * \brief È¡µÃºòÑ¡¿òÍ¼µÄ¸ß¶È[ºòÑ¡¿òÒ²ÊÇÒ»¸ölayout]
 * \param layoutId 
 * \return ºòÑ¡¿òÍ¼µÄ¸ß¶È
 * \autor ZhaoKun
 * \data 2010-10-22
 */
GBIMELOCAL GBUINT16 CLayoutAbstract_GetLayoutWidth(GBLPVOID pltObj, LayoutIdEnum layoutId)
{
	GBLPCVOID pSkinData = Global_GetSkinData();
	pltObj = pltObj;

	return CLayoutInfo_GetLayoutWidth(pSkinData, (GBUINT16)layoutId);
}

/*!
 * \brief ¸ù¾Ý°´Å¥¼üÖµ,È¡µÃ°´Å¥ÔÚÍ¼²ãÖÐµÄ×ø±ê
 * \param layoutId 
 * \return ºòÑ¡¿òÍ¼µÄ¸ß¶È
 * \autor huanjin
 * \data 2010-8-26
 */
GBIMELOCAL GBBOOL CLayoutAbstract_GetBottonRectByKey(GBLPVOID pltObj,LayoutIdEnum layoutId,
													 LayerIndex layerId, GBUINT16 iKeyValue, PGBRECT pRect)
{
	GBLPCVOID pSkinData = Global_GetSkinData();
	pltObj = pltObj;
	
	return CLayoutInfo_GetBottonRectByKey(pSkinData, (GBUINT16)layoutId,
		(GBUINT16)layerId, iKeyValue, pRect);
}

// È¡µÃ²ãµÄÐÅÏ¢
GBIMELOCAL PLAYOUTCONSTLAYER CLayoutAbstract_GetLayerConstInfo(GBLPVOID pltObj, LayoutIdEnum layoutId, LayerIndex layerId)
{
	GBLPCVOID pSkinData = Global_GetSkinData();
	pltObj = pltObj;

	return CLayoutInfo_GetLayerConstInfo(pSkinData, (GBUINT16)layoutId, (GBUINT16)layerId);
}
// È¡µÃ°´Å¥ÐÅÏ¢
GBIMELOCAL PBUTTONCONSTDATA CLayoutAbstract_GetLayerConstButtons(GBLPVOID pltObj, LayoutIdEnum layoutId, LayerIndex layerId)
{
	GBLPCVOID pSkinData = Global_GetSkinData();
	pltObj = pltObj;

	return CLayoutInfo_GetLayerConstButtons(pSkinData, (GBUINT16)layoutId, (GBUINT16)layerId);
}

/*!
 * \brief ÇÐ»»Layout´¦Àíº¯Êý
 * \param pltObj 
 * \return 
 * \note 
 * \author haj
 * \date 2010-8-27
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SwitchHandler(GBLPVOID pltObj)
{
	PCLayoutAbstract pltBase = (PCLayoutAbstract)pltObj;

	GBUINT16 targetLayoutID = 0;
	PCMAPPING_LAYOUTKEY2LAYOUTID pcMapCursor = &GBCMappingLayoutKey2ID[0];

	while (0 != pcMapCursor->layoutKey)
	{
		if (pcMapCursor->layoutKey == pltBase->currentLayoutKeyValue)
		{
			return Global_FillEventGroup(GBIME_CT_SWITCH, pcMapCursor->layoutID, 0);
		}

		pcMapCursor++;		
	} //while

	return GBIME_IGNORE;
}

/*!
 * \brief ¹¦ÄÜ¼ü´¦Àíº¯Êý
 * \param pltObj 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-8-25 11:22:00
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_FuncKeyHandler(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltBase = (PCLayoutAbstract)pltObj;
	GBUINT16 tempStr[2];

	pltBase->bUpToInputKeySequence = GBFalse;

	switch (pltBase->currentLayoutKeyValue)
	{
	case GBKEY_VK_SETTING: ///<ÉèÖÃ
		Global_FillEventGroup(GBIME_CT_CONFIG_MENU, 0, 0);
		break;
	case GBKEY_VK_V9_PINYIN_SEPARATOR://Æ´Òô·Ö¸ô·û
		if (pEngineOutputInfo->bCandWindOpen) // ÒýÇæ´¦Àí¹ý³ÌÖÐ£¬ÊäÈë·Ö¸ô·û
		{
			pltBase->bSendEngineKeyEvent = GBTrue;
			pltBase->engineKeyEvent = GBKEY_AMB_SPECIAL_A;
			Global_FillEventGroup(GBIME_CT_NORMAL_KEY_UP, 0, 0);
		}
		break;
	case GBKEY_VK_V9_SYMBOL_KEY: // MultiTap±êµã·ûºÅ´¦Àí		
		pltBase->m_pfcMultiTapSymbolHandler(pltObj);
		Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
		break;
	case GBKEY_VK_V9_SYMBOL_FACE_MULTIP_KEY: // MultiTap±íÇé·ûºÅ´¦Àí		
		pltBase->m_pfcMultiTapFaceHandler(pltObj);
		Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
		break;
	case GBKEY_RETURN: // ÎÞÊäÈëÊ±£¬µã»÷¡¾»Ø³µ¡¿¼ü£¬»»ÐÐ¡£ÊäÈëÊ±£¬µã»÷¡¾»Ø³µ¡¿¼ü£¬Êý×ÖÉÏÆÁ
		if (pEngineOutputInfo->bCandWindOpen)
		{
			// Êý×ÖÉÏÆÁÐèÒªÈ·±£´¦ÓÚ·ÇÑ¡Ôñ×´Ì¬
			GBEngine_ExitSelectedStatus(Global_GetEnineInstance());
			pltBase->bSendEngineKeyEvent = GBTrue;
			pltBase->engineKeyEvent = GBKEY_UP;
			pltBase->bUpToInputKeySequence = GBTrue;
			Global_FillEventGroup(GBIME_CT_NORMAL_KEY_UP, 0, 0);
		}
		else
		{
			tempStr[0] = GBKEY_RETURN;
			tempStr[1] = 0;
			pltBase->m_pfcUpScreen(pltObj, tempStr);
			Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
		}
		break;
	case GBKEY_SPACE: // ÎÞÊäÈëÊ±£¬µã»÷¡¾¿Õ¸ñ¡¿¼ü£¬ÊäÈë¿Õ¸ñ¡£ÊäÈëÊ±£¬µã»÷¡¾¿Õ¸ñ¡¿¼ü£¬ºòÑ¡Ê××ÖÉÏÆÁ
		if (pEngineOutputInfo->bCandWindOpen)
		{
			pltBase->bSendEngineKeyEvent = GBTrue;
			pltBase->engineKeyEvent = GBEVENT_SELECT_CANDIDATE;
			pltBase->engineEventParam = pltBase->currentCandidateIndex;
			pltBase->bUpToInputKeySequence = GBTrue;
			Global_FillEventGroup(GBIME_CT_NORMAL_KEY_UP, 0, 0);
		}
		else
		{
			tempStr[0] = GBKEY_SPACE;
			tempStr[1] = 0;
			pltBase->m_pfcUpScreen(pltObj, tempStr);
			Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
		}
		break;
	case GBKEY_BACK:
		if (pEngineOutputInfo->bCandWindOpen)
		{
			if (pEngineOutputInfo->isMultiTapInputMode)
			{
				pltBase->bSendEngineKeyEvent = GBTrue;
				pltBase->engineKeyEvent = GBKEY_OK;
				Global_FillEventGroup(GBIME_CT_NORMAL_KEY_UP, GBKEY_OK, 0);
			}
			else
			{
				Global_FillEventGroup(GBIME_CT_NORMAL_KEY_UP, GBKEY_BACK, 0);
			}
		}
		else
		{
			GBInputBox_DeleteChar();
			Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, GBKEY_BACK, 0);
		}
		break;
	case GBKEY_VK_CAP: // ÇÐ»»Ó¢ÎÄÊäÈë´óÐ¡Ð´
		if (GBEngine_IsAlpInputMode(Global_GetEnineInstance()))
		{
			pltBase->m_pfcSwitchShiftCapStatus(pltObj, 0, GBTrue, pEngineOutputInfo);	
		}
		break;
	case GBKEY_AMB_SPECIAL_A: // ÊäÈë¡®*¡¯
		tempStr[0] = '*';
		tempStr[1] = 0;
		pltBase->m_pfcUpScreen(pltObj, tempStr);
		Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
		break;
	case GBKEY_AMB_SPECIAL_B: // ÊäÈë¡®#¡¯
		tempStr[0] = '#';
		tempStr[1] = 0;
		pltBase->m_pfcUpScreen(pltObj, tempStr);
		Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
		break;
	default:
		return GBIME_IGNORE;
		break;
	}
	
	return GBIME_OK;
}


/*!
 * \brief ÇÐ»»»ØÇ°Ò»¸öLayout
 * \param pltObj 
 * \return 
 * \note 
 * \author haj
 * \date 2010-8-27
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SwitchPreLayoutObj(GBLPVOID pltObj)
{
	PCLayoutAbstract pltBase = (PCLayoutAbstract)pltObj;
	PCLayoutAbstract pltPrevObject = Global_GetPrevLayoutObject();

	if (pltPrevObject != NULL)
	{
		//return Global_FillEventGroup(GBIME_CT_SWITCH, LayoutIdSwitchPreObj, 0);
		return Global_FillPostEventGroup(GBIME_CT_SWITCH, LayoutIdSwitchPreObj, 0);
	}	

	return GBIME_LAYOUT_NOEXIST;
}
// ¸ù¾ÝÍ¼²ãIDºÍ²ãºÅ£¬È¡µÃºòÑ¡¿ò¸ß¶È(Í¼²ã²»´æÔÚ»ò²ÎÊý´íÎóÊ±£¬·µ»Ø0)
GBIMELOCAL GBINT16 CLayoutAbstract_GetCandidateBoxHeight(GBLPVOID pltObj, LayoutIdEnum layoutId, LayerIndex layerId)
{
	GBLPCVOID pSkinData = Global_GetSkinData();
	pltObj = pltObj;
	return CLayoutInfo_GetCandidateBoxHeight(pSkinData,(GBUINT16)layoutId,(GBUINT16)layerId);
}

/*!
 * \brief »ñÈ¡Layout´°¿ÚÏà¶ÔÓÚÆÁÄ»µÄÎ»ÖÃ(Layout×óÉÏ½Ç)
 * \param pltObj 
 * \param pWinPos 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-9-26 15:14:32
*/
GBIMELOCAL void CLayoutAbstract_GetWinPos(GBLPVOID pltObj, PGBIMEPoint pWinPos)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	PLayoutInfo pLayoutInfo = (PLayoutInfo)(&pltAbstractObj->m_ltData); // Layout UI data point
			
	GBUINT16 iCandidateBoxHeight = 0;
	GBUINT16 iKeyBoardHeight = 0;
	GBUINT16 iCurrentLayoutId;
	GBUINT16 iCurrentLayerNumber;

	iCurrentLayoutId = GET_LAYOUT_ID(pltAbstractObj);
	iCurrentLayerNumber = GET_LAYOUT_CURRENT_LAYER(pltAbstractObj);
	iKeyBoardHeight = pltAbstractObj->m_pfcGetLayoutHeight(pltObj,iCurrentLayoutId);
	iCandidateBoxHeight = pltAbstractObj->m_pfcGetCandidateBoxHeight(pltObj, iCurrentLayoutId, iCurrentLayerNumber);
	
	Global_GetWinPos(pWinPos);
	switch (iCurrentLayerNumber)
	{
	case FirstLayer:
		pWinPos->y -=  iKeyBoardHeight;
		break;
	case SecondLayer:
		pWinPos->y -=  (iKeyBoardHeight + iCandidateBoxHeight);
		break;
	case ThirdLayer:
		pWinPos->y -=  (iKeyBoardHeight + iCandidateBoxHeight);
		break;
	default:
		pWinPos->y -=  iKeyBoardHeight;
		break;
	}
}

/*!
 * \brief »ñÈ¡Layout´°¿ÚÓÐÐ§ÇøÓò
 * \param pltObj 
 * \param pLayoutWinRect 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-9-27 10:00:31
*/
GBIMELOCAL void CLayoutAbstract_GetLayoutWinRect(GBLPVOID pltObj, PGBRECT pLayoutWinRect)
{
	GBIMEPoint layoutWinStartPos;
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;	
	Global_GetWinPos(&layoutWinStartPos); // note: ×óÏÂ½ÇÎ»ÖÃ
	FILL_RECT(pLayoutWinRect, 
			  layoutWinStartPos.x, 
			  (GBINT16)(layoutWinStartPos.y - Global_GetLayoutWinHeight()), 
		      Global_GetLayoutWinWidth(), 
			  layoutWinStartPos.y);
}

/*!
 * \brief ÅÐ¶ÏÊÇ·ñÊÇÊäÈë°´¼ü
 * \param keyValue 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-9-17 17:22:37
*/
GBIMELOCAL GBBOOL CLayoutAbstract_IsInputKey(GBUINT16 keyValue)
{
	// ÒýÇæ¼üÖµ
	if ((keyValue > GBEvent_None) && (keyValue < GBKEY_VK_A_UPPER))
	{
		if (((keyValue >= GBKEY_0) && (keyValue <= GBKEY_9)) // Êý×Ö¼ü
			||((keyValue >= GBKEY_A) && (keyValue <= GBKEY_Z))) // ×ÖÄ¸¼ü
		{
			return GBTrue;
		}
		
	}
	else // ÐéÄâ¼üÅÌ¼üÖµ
	{
		if (((keyValue >= GBKEY_VK_A_UPPER)&&(keyValue <= GBKEY_VK_10_NUMBERKEY)))
		{
			return GBTrue;
		}		
	}

	return GBFalse;
}

/*!
 * \brief »¬ÆÁ´¥Ãþ±Ê°´ÏÂÏûÏ¢´¦Àíº¯Êý
 * \param pltObj 
 * \param pt 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-9-24 17:19:49
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SlidingPenDownHandler(GBLPVOID pltObj, GBIMEPoint pt)
{
#if GBIME_CFG_SLIDING_SWITCH_SUPPORT > 0
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBIMEPoint curPt;
	GBRECT layoutWinRect;

	curPt.x = pt.x;
	curPt.y = pt.y;
	CLayoutAbstract_GetLayoutWinRect(pltObj, &layoutWinRect);

	if (pltAbstractObj->isSlidingDisabled || !PT_PointIsInRect(curPt, layoutWinRect))
	{
		return GBIME_IGNORE;
	}
	
	// °´ÏÂÇå³ý»¬¶¯±ê¼Ç²¢Æô¶¯¼ÆÊ±Æ÷¡¢¼ÇÂ¼ÆðÊ¼Î»ÖÃ¡¢ÆðÊ¼Ê±¼ä
	memset(&pltAbstractObj->slidingOperation, 0, sizeof(SlidingOperation));
	pltAbstractObj->slidingOperation.startPos.x = curPt.x;
	pltAbstractObj->slidingOperation.startPos.y = curPt.y;
	pltAbstractObj->slidingOperation.lastMovePos.x = curPt.x;
	pltAbstractObj->slidingOperation.lastMovePos.y = curPt.y;
	pltAbstractObj->slidingOperation.slidingStartTime = PT_GetCurrentTime();
	pltAbstractObj->slidingOperation.slidingElapsedTime = 0;
	pltAbstractObj->slidingOperation.slidingStatus = GBIME_SLIDING_INIT; // ³õÊ¼×´Ì¬
#endif
	return GBIME_OK;
}

/*!
 * \brief »¬ÆÁ´¥Ãþ±Êµ¯ÆðÏûÏ¢´¦Àíº¯Êý[Çå³ý»¬¶¯²Ù×÷±äÁ¿]
 * \param pltObj 
 * \param pt 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-9-24 17:19:42
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SlidingPenUpHandler(GBLPVOID pltObj, GBIMEPoint pt)
{
#if GBIME_CFG_SLIDING_SWITCH_SUPPORT > 0
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;	
	PLayoutInfo pLayoutInfo = (PLayoutInfo)(&pltAbstractObj->m_ltData); // Layout UI data point

	if (pltAbstractObj->isSlidingDisabled)
	{
		return GBIME_IGNORE;
	}

	// Âú×ã»¬ÆÁ²Ù×÷Ìõ¼þÊµÏÖ»¬ÆÁÇÐ»»Layout
	if (pltAbstractObj->slidingOperation.slidingStatus == GBIME_SLIDING_EXCUTE_ACTION)
	{
		GBUINT16 targetLayoutID = CLayoutInfo_GetSlidingSwitchLayoutID(pLayoutInfo, pltAbstractObj->slidingOperation.slidingDirection);
		if (LayoutIdHide == targetLayoutID)
		{
			Global_FillEventGroup(GBIME_CT_HIDE, 0, 0);
		}
		else
		{
			Global_FillEventGroup(GBIME_CT_SWITCH, targetLayoutID, 0);
		}		
		// ½áÊø»¬ÆÁ²Ù×÷Çå³ý×´Ì¬Á¿
		memset(&pltAbstractObj->slidingOperation, 0, sizeof(SlidingOperation));
		return GBIME_OK;
	}
	memset(&pltAbstractObj->slidingOperation, 0, sizeof(SlidingOperation));
#endif
	return GBIME_IGNORE;
}

/*!
 * \brief »¬ÆÁ´¥Ãþ±ÊÒÆ¶¯ÏûÏ¢´¦Àíº¯Êý
 * \param pltObj 
 * \param pt 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-9-24 17:19:31
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SlidingPenMoveHandler(GBLPVOID pltObj, GBIMEPoint pt)
{
#if GBIME_CFG_SLIDING_SWITCH_SUPPORT > 0
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	PLayoutInfo pLayoutInfo = (PLayoutInfo)(&pltAbstractObj->m_ltData); // Layout UI data point
	GBIMEPoint curPt;
	GBINT16 distanceH = 0;
	GBINT16 distanceV = 0;
	GBU32 tempTime = 0;
	GBRECT layoutWinRect;
	GBSlidingDirection curSlidingDirection;

	curPt.x = pt.x;
	curPt.y = pt.y;
	CLayoutAbstract_GetLayoutWinRect(pltObj, &layoutWinRect);
	
	if (pltAbstractObj->isSlidingDisabled)
	{
		return GBIME_IGNORE;
	}

	if (pltAbstractObj->slidingOperation.slidingStatus == GBIME_SLIDING_EXCUTE_ACTION)
	{
		return GBIME_IGNORE;
	}

	// »®³öLayout´°¿ÚÓÐÐ§ÇøÓòÖØÖÃ×´Ì¬
	if (!PT_PointIsInRect(curPt, layoutWinRect))
	{
		memset(&pltAbstractObj->slidingOperation, 0, sizeof(SlidingOperation));
		return GBIME_IGNORE;
	}

	// ¼ÆËãµ±Ç°ºáÏò¡¢×ÝÏòÒÆ¶¯¾àÀë
	distanceH = curPt.x - pltAbstractObj->slidingOperation.lastMovePos.x;
	distanceV = curPt.y - pltAbstractObj->slidingOperation.lastMovePos.y;
	
	// ¼ÇÂ¼ÉÏÒ»¸öMoveµã×ø±ê
	pltAbstractObj->slidingOperation.lastMovePos.x = curPt.x;
	pltAbstractObj->slidingOperation.lastMovePos.y = curPt.y;

	// ·ÀÖ¹Æµ·±´¦Àí£¬Ìá¸ßÏìÓ¦ËÙ¶È
	if (ABS(distanceH) < GBIME_SLIDING_MINIMUM_PIXELS 
		&& ABS(distanceV) < GBIME_SLIDING_MINIMUM_PIXELS)
	{
		return GBIME_IGNORE;
	}

	// ÅÐ¶Ï·½Ïò
	if (distanceV < 0 && ABS(distanceH) <= ABS(distanceV))
	{
		curSlidingDirection = SLIDING_DIRECTION_UP;
	}
	else if (distanceV > 0 && ABS(distanceH) <= ABS(distanceV))
	{
		curSlidingDirection = SLIDING_DIRECTION_DOWN;
	}
	else if (distanceH < 0 && ABS(distanceH) > ABS(distanceV))
	{
		curSlidingDirection = SLIDING_DIRECTION_LEFT;
	}
	else if (distanceH > 0 && ABS(distanceH) > ABS(distanceV))
	{
		curSlidingDirection = SLIDING_DIRECTION_RIGHT;
	}

	// ¸ù¾Ý»¬¶¯×´Ì¬×ö´¦Àí
	switch (pltAbstractObj->slidingOperation.slidingStatus)
	{
	case GBIME_SLIDING_INIT: // ³õÊ¼×´Ì¬
		pltAbstractObj->slidingOperation.slidingStatus = GBIME_SLIDING_MOVING;
		pltAbstractObj->slidingOperation.slidingDirection = curSlidingDirection;
		break;
	case GBIME_SLIDING_MOVING: // ÒÆ¶¯×´Ì¬
		// »¬¶¯·½Ïò·¢Éú±ä»¯£¬ÖØÖÃ×´Ì¬
		if (curSlidingDirection != pltAbstractObj->slidingOperation.slidingDirection)
		{
			pltAbstractObj->slidingOperation.slidingDirection = curSlidingDirection;
			pltAbstractObj->slidingOperation.startPos.x = curPt.x;
			pltAbstractObj->slidingOperation.startPos.y = curPt.y;
			pltAbstractObj->slidingOperation.lastMovePos.x = curPt.x;
			pltAbstractObj->slidingOperation.lastMovePos.y = curPt.y;
			pltAbstractObj->slidingOperation.slidingStartTime = PT_GetCurrentTime();
			pltAbstractObj->slidingOperation.slidingElapsedTime = 0;
			pltAbstractObj->slidingOperation.slidingSpeed = 0;
			pltAbstractObj->slidingOperation.slidingDistance = 0;
		}
		else
		{
			// ¸üÐÂ»¬¶¯Ê±¼ä
			tempTime = PT_GetCurrentTime();
			pltAbstractObj->slidingOperation.slidingElapsedTime = tempTime - pltAbstractObj->slidingOperation.slidingStartTime;
			
			// ¸üÐÂ¾àÀë¡¢ËÙ¶È
			distanceH = ABS(curPt.x - pltAbstractObj->slidingOperation.startPos.x);
			distanceV = ABS(curPt.y - pltAbstractObj->slidingOperation.startPos.y);
			//pltAbstractObj->slidingOperation.slidingDistance = (GBINT)(ABS(sqrt((distanceH * distanceH) + (distanceV * distanceV))));
			pltAbstractObj->slidingOperation.slidingDistance = PT_GetPointDistance(distanceH, distanceV);
			if (pltAbstractObj->slidingOperation.slidingElapsedTime > 0)
			{
				pltAbstractObj->slidingOperation.slidingSpeed = pltAbstractObj->slidingOperation.slidingDistance * 1000
					/ pltAbstractObj->slidingOperation.slidingElapsedTime;
			}
			
			// Âú×ã»¬ÆÁÒªÇó£¬ÊµÏÖLayout»¬ÆÁÇÐ»»
			if (pltAbstractObj->slidingOperation.slidingSpeed >= GBIME_SLIDING_ACTION_SPEED_REQUIRED
				&& pltAbstractObj->slidingOperation.slidingDistance >= GBIME_SLIDING_ACTION_DISTANCE_REQUIRED)
			{
				pltAbstractObj->slidingOperation.slidingStatus = GBIME_SLIDING_EXCUTE_ACTION; // Ö´ÐÐ»¬ÆÁ²Ù×÷×´Ì¬
			}
		}
		break;
	default:
		break;
	}

// 	PT_PrintLogInfo(GBLOG_LAYOUTINFO, ("########### »¬¶¯ËÙ¶È[%d], »¬¶¯¾àÀë[%d] ########\n", 
// 					pltAbstractObj->slidingOperation.slidingSpeed, 
// 					pltAbstractObj->slidingOperation.slidingDistance));
#endif
	return GBIME_OK;
}

/*!
 * \brief ³¤°´¼ü´¦Àíº¯Êý(´¦Àí³¤°´É¾³ý)
 * \param pltObj 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 *\example
 * \author weizhiping
 * \date 2010-12-17 11:20:44
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract_LongPressKeyHandler(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;

	switch (pltAbstractObj->currentLayoutKeyValue)
	{
	case GBKEY_BACK:
		if (pltAbstractObj->buttonStatus == ButtonStatusDown)
		{
			PT_GUIStartTimer(GBIME_LONG_PRESS_TIME, CLayoutAbstract_DeleteAll);		
		} 
		else if (pltAbstractObj->buttonStatus == ButtonStatusUp) // °´¼üµ¯ÆðÈ¡Ïû»Øµ÷
		{
			PT_GUICancelTimer(CLayoutAbstract_DeleteAll);
			if (pltAbstractObj->bLongPressFlag)
			{
				pltAbstractObj->bLongPressFlag = GBFalse;
				Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
				return GBIME_OK; // ½áÊø´¦Àí£¬²»¼ÌÐøÅÜ¶Ì°´GBKEY_BACKµÄ¹¦ÄÜ´¦Àí´úÂë
			}
		}
		break;
	default:
		return GBIME_IGNORE;
		break;
	}

	return GBIME_IGNORE;
}

/*!
 * \brief ³¤°´É¾³ý´¦Àíº¯Êý
 * \param void 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-9 9:49:00
*/
GBIMELOCAL void CLayoutAbstract_DeleteAll(void)
{
	//PCLayoutControl pLtCtl = Global_GetLayoutCtl();
	PEngineOutputInfo pEngineOutputInfo = CLayoutControl_GetEngineOutputInfo();
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)Global_GetCurrentLayoutObject();

	// Çå¿ÕÒýÇæÊäÈë´®ÄÚÈÝ
	if (pEngineOutputInfo->bCandWindOpen/* && !pEngineOutputInfo->bInputEmpty*/)
	{		
		GBEngine_Reset(Global_GetEnineInstance());
		CLayoutControl_UpdateOutputInfo();
		pltAbstractObj->m_pfcCloseCandWin(pltAbstractObj, pEngineOutputInfo);
	}
	else // Çå¿Õ±à¼­Æ÷ÊäÈë¿òÄÚÈÝ
	{
		GBInputBox_DeleteAll();
	}

	pltAbstractObj->bLongPressFlag = GBTrue;
	
	// ÖØÖÃ¹¦ÄÜ°´¼ü¼°ÒýÇæ×´Ì¬²¢¹Ø±ÕºòÑ¡¿ò
	//GBResetFuncKey();
}

/*!
 * \brief ÏÔÊ¾ºòÑ¡¿ò(½øÈëµÚ¶þ²ãÊäÈë×´Ì¬)
 * \param pltObj 
 * \param buttonStatus 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-19 9:56:58
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_ShowCandWin(GBLPVOID pltObj, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBUINT16 iCandidateBoxHeight = 0;
	GBUINT16 iKeyBoardHeight = 0;
	GBUINT16 iCurrentLayoutId;
	
	iCurrentLayoutId = GET_LAYOUT_ID(pltAbstractObj);
	iKeyBoardHeight = pltAbstractObj->m_pfcGetLayoutHeight(pltObj,iCurrentLayoutId);

	if (buttonStatus == ButtonStatusUp)
	{
		if (pltAbstractObj->m_pfcIsInputKey(pltAbstractObj->currentLayoutKeyValue))
		{
			pltAbstractObj->currentSyllableIndex = 0; // ÇåÁãÒô½ÚË÷Òý
			pltAbstractObj->currentCandidateIndex = 0; // ÇåÁãºòÑ¡Ë÷Òý
			pltAbstractObj->m_ltData.ltCurLayer = SecondLayer;
			iCandidateBoxHeight = pltAbstractObj->m_pfcGetCandidateBoxHeight(pltObj, GET_LAYOUT_ID(pltAbstractObj), SecondLayer);
			pltAbstractObj->m_pfcChangeHeight(pltObj, iKeyBoardHeight+iCandidateBoxHeight);
			return GBIME_OK;
		}
	}

	return GBIME_IGNORE;
}

/*!
 * \brief ÏÔÊ¾ÁªÏë¿ò(½øÈëµÚÈý²ãÁªÏë×´Ì¬)
 * \param pltObj 
 * \param buttonStatus 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-19 9:56:58
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_ShowAssociateWin(GBLPVOID pltObj, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBUINT16 iCandidateBoxHeight = 0;
	GBUINT16 iKeyBoardHeight = 0;
	GBUINT16 iCurrentLayoutId;
	
	iCurrentLayoutId = GET_LAYOUT_ID(pltAbstractObj);
	iKeyBoardHeight = pltAbstractObj->m_pfcGetLayoutHeight(pltObj,iCurrentLayoutId);
	iCandidateBoxHeight = pltAbstractObj->m_pfcGetCandidateBoxHeight(pltObj, iCurrentLayoutId, ThirdLayer);
	
	pltAbstractObj->currentSyllableIndex = 0; // ÇåÁãÒô½ÚË÷Òý
	pltAbstractObj->m_ltData.ltCurLayer = ThirdLayer;	
	pltAbstractObj->m_pfcChangeHeight(pltObj, iKeyBoardHeight + iCandidateBoxHeight);
	return GBIME_OK;
}

/*!
 * \brief ¸ù¾ÝÒýÇæºòÑ¡¿ò×´Ì¬¾ö¶¨ÊÇ·ñ¹Ø±ÕLayoutÃæ°åºòÑ¡À¸
 * \param pltObj 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-19 10:12:16
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_CloseCandWin(GBLPVOID pltObj, PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBUINT16 iKeyBoardHeight = pltAbstractObj->m_pfcGetLayoutHeight(pltObj, GET_LAYOUT_ID(pltAbstractObj));

	if (!pEngineOutputInfo->bCandWindOpen) // ÊäÈë´®Îª¿ÕÊ±
	{
		pltAbstractObj->currentSyllableIndex = 0; // ÇåÁãÒô½ÚË÷Òý
		pltAbstractObj->m_ltData.ltCurLayer = FirstLayer;
		pltAbstractObj->m_pfcChangeHeight(pltObj, iKeyBoardHeight);
		return GBIME_OK;
	}

	return GBIME_IGNORE;
}

/*!
 * \brief ¼ì²âÊÇ·ñÐèÒªÉÏÆÁºòÑ¡×Ö
 * \param pltObj 
 * \param buttonStatus 
 * \param pEngineOutputInfo 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-19 10:15:15
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_CheckUpScreen(GBLPVOID pltObj, ButtonStatusEnum buttonStatus, PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;

	if ((buttonStatus == ButtonStatusUp 
		 && pltAbstractObj->penInPostion == PenPositionInCandidate
		 && pltAbstractObj->penDownPostion == PenPositionInCandidate)
	    || pltAbstractObj->bUpToInputKeySequence) // Êý×ÖÉÏÆÁ
	{
		pltAbstractObj->currentCandidateIndex = 0;
		pltAbstractObj->m_pfcUpScreen(pltObj, pEngineOutputInfo->pUpScreenStr);
		return GBIME_OK;
	}

	return GBIME_IGNORE;
}

/*!
 * \brief MultiTap·ûºÅ´¦Àíº¯Êý
 * \param pltObj 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-20 16:43:20
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_MultiTapSymbolHandler(GBLPVOID pltObj)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBWCHAR *pSymbolArray;
	GBUINT16 symbolNum = 0;
	GBWCHAR hlightSymbolString[2];

	pSymbolArray = CLayoutInfo_GetBottonKeyName(Global_GetSkinData(), GET_LAYOUT_ID(pltAbstractObj), 
							GET_LAYOUT_CURRENT_LAYER(pltAbstractObj), pltAbstractObj->currentLayoutKeyValue);

	if (pSymbolArray == NULL || wcslen(pSymbolArray) == 0)
	{
		return GBIME_FAILED;
	}

	symbolNum = wcslen(pSymbolArray);
	if (pltAbstractObj->multitapCandIndex == symbolNum)
	{
		pltAbstractObj->multitapCandIndex = 0;
	}
	hlightSymbolString[0] = pSymbolArray[pltAbstractObj->multitapCandIndex];
	hlightSymbolString[1] = 0;
	pltAbstractObj->multitapReplaceCandLength = GBInputBox_ReplaceHighlightString(pltAbstractObj->multitapReplaceCandLength, (GBPCWCHAR)hlightSymbolString);
	PT_GUIStartTimer(GBIME_MULTITAP_TIMER_INTERVAL, pltAbstractObj->m_pfcOnMultitapTimer);
	pltAbstractObj->bMultitapTimerStartFlag = GBTrue;
	pltAbstractObj->bMultitapSymbolStartFlag = GBTrue;
	pltAbstractObj->multitapCandIndex++;

	return GBIME_OK;
}

/*!
 * \brief MultiTap±íÇé·ûºÅ´¦Àíº¯Êý
 * \param pltObj 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-20 16:43:12
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_MultiTapFaceHandler(GBLPVOID pltObj)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBWCHAR *pFaceString;
	GBWCHAR *pFaceStart;
	GBINT faceStrLen = 0;
	GBINT faceNum = 0;
	GBWCHAR faceArray[GBIME_MULTITAP_FACE_NUM][GBIME_MULTITAP_FACE_LEN + 1];
	GBUINT16 symbolNum = 0;
	GBINT i =  0;

	pFaceString = CLayoutInfo_GetBottonKeyName(Global_GetSkinData(), GET_LAYOUT_ID(pltAbstractObj), 
							GET_LAYOUT_CURRENT_LAYER(pltAbstractObj), pltAbstractObj->currentLayoutKeyValue);

	// ·Ç·¨±íÇé·ûºÅ´®£¬¼ì²éÆ¤·ô¹¤¾ßÌîÐ´µÄ±íÇé°´¼üÃû³Æ
	if (pFaceString == NULL || wcslen(pFaceString) == 0)
	{
		return GBIME_FAILED;
	}

	// ²ð·Ö±íÇé·ûºÅ
	pFaceStart = pFaceString;
	faceStrLen = wcslen(pFaceString);
	for (i = 0; i < faceStrLen; i++)
	{
		if (pFaceString[i] == GBIME_MULTITAP_FACE_SPLIT_CHAR)
		{
			GBINT curFaceLen = (GBINT)(pFaceString + i - pFaceStart);
			wcsncpy(faceArray[faceNum], pFaceStart, curFaceLen);
			faceArray[faceNum][curFaceLen] = 0; // ½áÊø·û
			pFaceStart = pFaceString + i + 1;
			faceNum++;
		}
	}

	// ·Ç·¨±íÇé·ûºÅ´®£¬¼ì²éÆ¤·ô¹¤¾ßÌîÐ´µÄ±íÇé°´¼üÃû³Æ
	if (faceNum == 0)
	{
		return GBIME_FAILED;
	}

	if (pltAbstractObj->multitapCandIndex == faceNum)
	{
		pltAbstractObj->multitapCandIndex = 0;
	}

	pltAbstractObj->multitapReplaceCandLength = GBInputBox_ReplaceHighlightString(pltAbstractObj->multitapReplaceCandLength, 
															(GBPCWCHAR)faceArray[pltAbstractObj->multitapCandIndex]);
	PT_GUIStartTimer(GBIME_MULTITAP_TIMER_INTERVAL, pltAbstractObj->m_pfcOnMultitapTimer);
	pltAbstractObj->bMultitapTimerStartFlag = GBTrue;
	pltAbstractObj->bMultitapFaceStartFlag = GBTrue;
	pltAbstractObj->multitapCandIndex++;
	return GBIME_OK;
}

/*!
 * \brief MultiTap·ûºÅ¹¦ÄÜ¶¨Ê±Æ÷¼ä¸ôµ½´ïÊ±µÄÏìÓ¦º¯Êý
 * \param void 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-20 11:32:42
*/
static void CLayoutAbstract_OnMultitapTimer(void)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)Global_GetCurrentLayoutObject();

	if (pltAbstractObj->bMultitapTimerStartFlag)
	{
		pltAbstractObj->bMultitapTimerStartFlag = GBFalse;
		pltAbstractObj->bMultitapSymbolStartFlag = GBFalse;
		pltAbstractObj->bMultitapFaceStartFlag = GBFalse;
		pltAbstractObj->multitapReplaceCandLength = 0;
		pltAbstractObj->multitapCandIndex = 0;
		PT_GUICancelTimer(pltAbstractObj->m_pfcOnMultitapTimer);
		GBInputBox_MultitapInputConfirm();
	}
}

/*!
 * \brief shiftCap×´Ì¬ÇÐ»»(Í¬²½ÇÐ»»GBV5ÒýÇæshiftCap×´Ì¬)
 * \param pltObj 
 * \param shiftCapStatus ÇÐ»»µ½Ö¸¶¨×´Ì¬
 * \param bAuto ×Ô¶¯Ñ­»·ÇÐ»»
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-21 11:29:08
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SwitchShiftCapStatus(GBLPVOID pltObj, 
															GBShiftCapStatus shiftCapStatus, 
															GBBOOL bAuto,
															PEngineOutputInfo pEngineOutputInfo)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)Global_GetCurrentLayoutObject();
	GBUINT16 iCurrentLayoutId = GET_LAYOUT_ID(pltAbstractObj);
	GBShiftCapStatus curShiftCapStatus = Global_GetShiftCapStatus();

	if (!GBEngine_IsAlpInputMode(Global_GetEnineInstance()))
	{
		return GBIME_IGNORE;
	}

	if (bAuto)
	{
		switch (curShiftCapStatus)
		{
		case GBStatus_Normal:
			Global_SetShiftCapStatus(GBStatus_Shift);
			Global_FillEventGroup(GBIME_CT_SWITCH, CLayoutInfo_GetUpperLayoutID(iCurrentLayoutId), 0);
			break;
		case GBStatus_Shift:
			Global_SetShiftCapStatus(GBStatus_Caplock);
			Global_FillEventGroup(GBIME_CT_KEY_UP_REFRESH, 0, 0); // °´Å¥µ¯ÆðË¢ÐÂ
			break;
		case GBStatus_Caplock:
			Global_SetShiftCapStatus(GBStatus_Normal);		
			Global_FillEventGroup(GBIME_CT_SWITCH, CLayoutInfo_GetLowerLayoutID(iCurrentLayoutId), 0);
			break;
		default:
			break;
		}
		
		// Èç¹ûÊÇÊäÈë×´Ì¬£¬¼ÇÂ¼µ±Ç°ÊäÈë´®£¬µÈÇÐ»»µ½Ä¿±êLayoutÔÙÖØÐÂÉèÖÃÊäÈë´®²¢ÏÔÊ¾ÎªÖ¸¶¨µÄ´óÐ¡Ð´×´Ì¬
// 		if (pEngineOutputInfo->bCandWindOpen 
// 			&& pEngineOutputInfo->pInputString != NULL
// 			&& wcslen(pEngineOutputInfo->pInputString) > 0)
// 		{
// 			wcsncpy(pltAbstractObj->backupEngineInputString, pEngineOutputInfo->pInputString, GB_INPUT_BUFFER_LEN);///<±¸·ÝÒýÇæÊäÈëÐòÁÐ
// 			pltAbstractObj->bReuseInputStringFlag = GBTrue;
// 		}
	}
	else // Ö¸¶¨ÇÐ»»µ½Ä¿±ê×´Ì¬¼°ÏàÓ¦µÄLayout[Ê××ÖÄ¸´óÐ´ÉÏÆÁºó½øÈëºó´¦ÀíÇÐ»»»ØÐ¡Ð´Layout]
	{
		Global_SetShiftCapStatus(shiftCapStatus);
		switch (shiftCapStatus)
		{
		case GBStatus_Normal:		
			Global_FillPostEventGroup(GBIME_CT_SWITCH, CLayoutInfo_GetLowerLayoutID(iCurrentLayoutId), 0);
			break;
		case GBStatus_Shift:
		case GBStatus_Caplock:
			Global_FillPostEventGroup(GBIME_CT_SWITCH, CLayoutInfo_GetUpperLayoutID(iCurrentLayoutId), 0);
			break;
		default:
			break;
		}
	}
	

	return GBIME_OK;
}

/*!
 * \brief Í¬²½ÒýÇæshiftCap×´Ì¬
 * \param pltObj 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-22 12:52:49
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SyncEngineShiftCapStatus(GBLPVOID pltObj)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBINT bShiftDown;
	GBINT bCapsLockToggle;
	GBShiftCapStatus curShiftCapStatus = Global_GetShiftCapStatus();

	if (GBEngine_IsAlpInputMode(Global_GetEnineInstance()))
	{
		bShiftDown = (curShiftCapStatus == GBStatus_Shift) ? GBTrue : GBFalse;
		bCapsLockToggle = (curShiftCapStatus == GBStatus_Caplock) ? GBTrue : GBFalse;
		GBEngine_SetShiftCap(Global_GetEnineInstance(), bShiftDown, bCapsLockToggle);
		return GBIME_OK;
	}

	return GBIME_IGNORE;	
}

/*!
 * \brief »ñÈ¡LayoutÆðµã×ø±ê
 * \param pltObj 
 * \return 
 * \note 
 * \example
 * \author Zhaokun
 * \date 2010-10-23 11:46:08
*/
GBIMELOCAL void CLayoutAbstract_GetLayoutStartPoint(GBLPVOID pltObj, PGBIMEPoint pStartPoint)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBUINT16 iKeyBoardHeight = 0;
	GBUINT16 iKeyBoardWidth = 0;
	GBIMEPoint winPos;
	GBUINT16 iCurrentLayoutId;
	GBUINT16 iCandidateBoxHeight;
	GBINT16 iScreenWidth = 0;

	if(!pStartPoint)
	{
		return;
	}

	// µ±Ç°LayoutId
	iCurrentLayoutId = GET_LAYOUT_ID(pltAbstractObj);
	// »ñÈ¡¼üÅÌ¸ß¶È
	iKeyBoardHeight = pltAbstractObj->m_pfcGetLayoutHeight(pltObj,iCurrentLayoutId);
	iKeyBoardWidth = pltAbstractObj->m_pfcGetLayoutWidth(pltObj, iCurrentLayoutId);
	// È¡µÃ¼üÅÌÏÔÊ¾µÄ¿ªÊ¼Î»ÖÃ¡¾×óÏÂ½Ç¡¿£¬²¢µ÷ÕûÎª¡¾×óÉÏ½Ç¡¿
	Global_GetWinPos(&winPos);	
	winPos.y -=  iKeyBoardHeight;
	
	iScreenWidth = PT_GetLcdWidth();
	
	// È¡ºòÑ¡¿ò¸ß¶È
	iCandidateBoxHeight = pltAbstractObj->m_pfcGetCandidateBoxHeight(pltObj,iCurrentLayoutId,FirstLayer);
	// Ïà¼õµÃµ½ºòÑ¡¿ò×óÉÏ½ÇY×ø±ê
	winPos.y -= iCandidateBoxHeight;

	// ÏÔÊ¾Í¼Æ¬µÄ×óÉÏ½ÇX×ø±ê
	pStartPoint->x = (GBUINT16)winPos.x + (iScreenWidth - iKeyBoardWidth) / 2;
	// ÏÔÊ¾Í¼Æ¬µÄ×óÉÏ½ÇY×ø±ê
	pStartPoint->y = (GBUINT16)winPos.y;
}

/*!
 * \brief ÉèÖÃÒô½ÚºòÑ¡ÆðÊ¼ÏÔÊ¾Î»ÖÃ
 * \param pltObj 
 * \param x 
 * \param y 
 * \return 
 * \note 
 *\example
 * \author weizhiping
 * \date 2010-12-17 18:17:16
 */
GBIMELOCAL void CLayoutAbstract_SetSyllableDisplayStartPos(GBLPVOID pltObj, GBINT16 x, GBINT16 y)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	pltAbstractObj->syllableDisplayStartPos.x = x;
	pltAbstractObj->syllableDisplayStartPos.y = y;
}

/*!
 * \brief ÉèÖÃºòÑ¡×ÖÆðÊ¼ÏÔÊ¾Î»ÖÃ
 * \param pltObj 
 * \param x 
 * \param y 
 * \return 
 * \note 
 *\example
 * \author weizhiping
 * \date 2010-12-17 18:17:29
 */
GBIMELOCAL void CLayoutAbstract_SetCandidateDisplayStartPos(GBLPVOID pltObj, GBINT16 x, GBINT16 y)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	pltAbstractObj->candidateDisplayStartPos.x = x;
	pltAbstractObj->candidateDisplayStartPos.y = y;
}

/*!
 * \brief ÎïÀí¼üÅÌABC MultiTap¶¨Ê±Æ÷¼ä¸ôµ½´ïÊ±µÄÏìÓ¦º¯Êý
 * \param void 
 * \return 
 * \note 
 * \example
 * \author weizhiping
 * \date 2010-10-20 11:32:42
*/
static void CLayoutAbstract_KBMultiTapTimerCallBack(void)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)Global_GetCurrentLayoutObject();
	PEngineOutputInfo pEngineOutputInfo = CLayoutControl_GetEngineOutputInfo();
	if (pltAbstractObj->bMultitapTimerStartFlag)
	{
		GBInputBox_MultitapInputConfirm();
		GBEngine_SendKeyEvent(Global_GetEnineInstance(), GBKEY_OK, 0);
		CLayoutControl_UpdateOutputInfo();
		pltAbstractObj->bMultitapTimerStartFlag = GBFalse;
		pltAbstractObj->multitapReplaceCandLength = 0;

		if (!pEngineOutputInfo->bCandWindOpen)
		{
			pltAbstractObj->currentSyllableIndex = 0; // ÇåÁãÒô½ÚË÷Òý
			Global_SetLayoutWinActiveStatus(GBFalse);
			GBInputBox_SetAllPlatformFuncKey();
			pltAbstractObj->m_pfcChangeHeight(pltAbstractObj, 0);		
			return;
		}
	}
}

//////////////////////////////////////////////////////////////////////////
///>start [static const data]
// ÖÐÎÄ·ûºÅ¡¾ "¡£ £¿ £¡ £¬ £º ¡­¡­¡¿
static const GBWCHAR symbols_chn[][GBIME_SYMBOL_MAX_LEN] = 
{
	{ 0xFF1F, 0x0000 }, // £¿
	{ 0xFF01, 0x0000 }, // £¡
	{ 0xFF0C, 0x0000 }, // £¬
	{ 0x3002, 0x0000 }, // ¡£
	{ 0xFF1A, 0x0000 }, // £º
	{ 0x2026, 0x2026, 0x0000 }, // ¡­¡­

	{ 0x3001,0x0000 }, //¡¢
	{ 0xff1b,0x0000 }, //£»
	{ 0x2014,0x0000 }, //¡ª
	{ 0x201c,0x201d,0x0000 }, //¡°¡±
	{ 0xff08,0xff09,0x0000 }, //£¨£©
};
const GBWCHAR * symbolsTable_1_Chn[] = 
{
	symbols_chn[0],	symbols_chn[1],	symbols_chn[2],	symbols_chn[3],	symbols_chn[4],	symbols_chn[5],
	symbols_chn[6],	symbols_chn[7],	symbols_chn[8],	symbols_chn[9],	symbols_chn[10]
};

// Ó¢ÎÄ·ûºÅ¡¾,.?!':¡­¡¿
const GBWCHAR symbols_alp[][GBIME_SYMBOL_MAX_LEN] = 
{
	{ 0x003F, 0x0000 }, // ?
	{ 0x0021, 0x0000 }, // !
	{ 0x002C, 0x0000 }, // ,
	{ 0x002E, 0x0000 }, // .
	{ 0x0027, 0x0000 }, // '
	{ 0x0040,0x0000 }, //@

	{ 0x2026, 0x0000 }, // ¡­
	{ 0x003A, 0x0000 }, // :
	{ 0x003b,0x0000 }, //;
	{ 0x002d,0x0000 }, //-
	{ 0x005f,0x0000 }, //_
	{ 0x002f,0x0000 }, ///
};
const GBWCHAR * symbolsTable_1_Alp[] = 
{
	symbols_alp[0],	symbols_alp[1],	symbols_alp[2],	symbols_alp[3],	symbols_alp[4],		symbols_alp[5], 
	symbols_alp[6],	symbols_alp[7],	symbols_alp[8],	symbols_alp[9],	symbols_alp[10],	symbols_alp[11]
};

// ±íÇé·ûºÅ¡¾:-)  ;-)  :-D :-p  -.-||¡¿
const GBWCHAR faces[][GBIME_FACE_MAX_LEN] =
{
	{ 0x003A, 0x002D, 0x0029, 0x0000 } // :-) ¿ªÐÄ
	,{ 0x003a,0x002d,0x0028,0x0000} //:-(
	,{ 0x003A, 0x002D, 0x0044, 0x0000 } // :-D ¿ªÐÄ
	,{ 0x003A, 0x002D, 0x0070, 0x0000 } // :-p
	,{ 0x002D, 0x002E, 0x002D, 0x007C, 0x007C, 0x0000 } // -.-||

	,{ 0x004f,0x0072,0x007a,0x0000 } //Orz
	,{ 0x003a,0x002d,0x0078,0x0000 } //:-x
	,{ 0x003a,0x002d,0x004f,0x0000 } //:-O
	,{ 0x005e,0x005f,0x005e,0x0000 } //^_^
	,{ 0x0054,0x005f,0x0054,0x0000 } //T_T
};
const GBWCHAR * facesTable_0[] =
{
	faces[0],	faces[1],	faces[2], faces[3],	faces[4],
	faces[5],	faces[6],	faces[7], faces[8],	faces[9]
};
///>end [static const data]
//////////////////////////////////////////////////////////////////////////
GBIMELOCAL GBUINT16 ICLayoutAbstract_GetStaticArraySize_symbolsTable_1_Alp(void)
{
	return PT_ARRAY_SIZE(symbolsTable_1_Alp);
}
GBIMELOCAL GBUINT16 ICLayoutAbstract_GetStaticArraySize_symbolsTable_1_Chn(void)
{
	return PT_ARRAY_SIZE(symbolsTable_1_Chn);
}
GBIMELOCAL GBUINT16 ICLayoutAbstract_GetStaticArraySize_facesTable(void)
{
	return PT_ARRAY_SIZE(facesTable_0);
}
/*!
 * \brief ÖØÖÃ±êµã·ûºÅ¼ü
 * \param pltObj 
 * \return 
 * \note 
 * \example
 * \author Zhaokun
 * \date 2010-11-24 10:00:14
*/
static void ICLayoutAbstract_ResetInterpunctionKey(GBLPVOID pltObj)
{
	GBEngine_UnregisterInterpunctionKey(Global_GetEnineInstance(), GBKEY_0);
	GBEngine_UnregisterInterpunctionKey(Global_GetEnineInstance(), GBKEY_1);
}

/*!
 * \brief ÉèÖÃ±êµã·ûºÅ°´¼ü
 * \param pltObj 
 * \return 
 * \note 
 * \example
 * \author Zhaokun
 * \date 2010-11-24 10:00:14
*/
GBIMELOCAL GBIMEReturn CLayoutAbstract_SetInterpunctionKey(GBLPVOID pltObj)
{
	//CLASE_THIS_POITER(CLayoutVK, pltObj)
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	GBINT size = 0;
	GBBOOL bChineseFlag = GBFalse;
	GBINT iChnSymbolsTableSize = ICLayoutAbstract_GetStaticArraySize_symbolsTable_1_Chn();
	GBINT iAlpSymbolsTableSize = ICLayoutAbstract_GetStaticArraySize_symbolsTable_1_Alp();
	GBINT iFacesTableSize = ICLayoutAbstract_GetStaticArraySize_facesTable();

	ICLayoutAbstract_ResetInterpunctionKey(pltObj);

	switch(pltAbstractObj->m_ltData.pltcData->ltID)
	{
	case LayoutIdSP9JPinYin:		// 9¼üÆ´Òô
	case LayoutIdSP26JPinYin:		// 26¼üÆ´Òô
	case LayoutIdHP9JPinYin:		// ºáÆÁ9¼üÆ´Òô
	case LayoutIdHP26JPinYin:		// ºáÆÁ26¼üÆ´Òô

	case LayoutIdWL9JPinYin:
	case LayoutIdWL26JPinYin:
		bChineseFlag = GBTrue;
		break;
	case LayoutIdSP9JLowerEnglish:  // 9¼üÓ¢ÎÄÐ¡Ð´
	case LayoutIdSP26JLowerEnglish: // 26¼üÓ¢ÎÄÐ¡Ð´
	case LayoutIdHP26JEnglish:      // ºáÆÁ26¼üÓ¢ÎÄ
	case LayoutIdHP9JEnglish:		// ºáÆÁ9¼üÓ¢ÎÄ

	case LayoutIdWL9JEnglish:
	case LayoutIdWL26JEnglish:
		bChineseFlag = GBFalse;
		break;
	default:
		return GBIME_IGNORE; // ÆäËûLayout²»´¦Àí
	}

	// ¸øÖÐÓ¢ÎÄ·ûºÅ×Ö·û´®ÉêÇëÄÚ´æ
	if (bChineseFlag)
	{
		if (pltAbstractObj->pSymbolChineseString != NULL)
		{
			PT_Free(pltAbstractObj->pSymbolChineseString);
			pltAbstractObj->pSymbolChineseString = NULL;
		}
		size = iChnSymbolsTableSize * GBIME_SYMBOL_MAX_LEN * sizeof(GBWCHAR);
		pltAbstractObj->pSymbolChineseString = (GBWCHAR *)PT_Malloc(size);
		PT_Assert(pltAbstractObj->pSymbolChineseString != NULL);
		memset(pltAbstractObj->pSymbolChineseString, 0, size);
	}
	else
	{
		if (pltAbstractObj->pSymbolEnglishString != NULL)
		{
			PT_Free(pltAbstractObj->pSymbolEnglishString);
			pltAbstractObj->pSymbolEnglishString = NULL;
		}
		size = iAlpSymbolsTableSize * GBIME_SYMBOL_MAX_LEN * sizeof(GBWCHAR);
		pltAbstractObj->pSymbolEnglishString = (GBWCHAR *)PT_Malloc(size);
		PT_Assert(pltAbstractObj->pSymbolEnglishString != NULL);
		memset(pltAbstractObj->pSymbolEnglishString, 0, size);
	}
	
	if (pltAbstractObj->pFaceString != NULL)
	{
		PT_Free(pltAbstractObj->pFaceString);
		pltAbstractObj->pFaceString = NULL;
	}
	size = iFacesTableSize * GBIME_FACE_MAX_LEN * sizeof(GBWCHAR);
	pltAbstractObj->pFaceString = (GBWCHAR *)PT_Malloc(size);
	PT_Assert(pltAbstractObj->pFaceString != NULL);
	memset(pltAbstractObj->pFaceString, 0, size);

	GBEngine_SetEngineOption(Global_GetEnineInstance(), GB_ENGINE_FUNCTION,	GBFO_Alp_All_Num_Can_Continuously_Input, 1);			
	GBEngine_SetEngineOption(Global_GetEnineInstance(), GB_ENGINE_FUNCTION,	GBFO_Multi_Tap_Show_Cand_Wnd, 1); // ¹ØÁªÅäÖÃ

	if (bChineseFlag)
	{
		// 1¼ü·ûºÅ
		PT_ConvertFaceString(pltAbstractObj->pSymbolChineseString, symbolsTable_1_Chn, iChnSymbolsTableSize);
		GBEngine_RegisterInterpunctionKeyEx(Global_GetEnineInstance(), 
											GBKEY_1, 
											(GBLPCWCHAR)pltAbstractObj->pSymbolChineseString, 
											GBIME_SPLIT_CHAR, 
											GBCL_MULTITAP, 
											GBIME_SYMBOL_1_ROW_NUM, 
											iChnSymbolsTableSize, 
											GBIKO_Input_Status_Confirm_Candidate);

		// ÎïÀíLayout 0¼ü³öÀ´»Ø³µ¡¢¿Õ¸ñ
		if (IS_KB_LAYOUT(GET_LAYOUT_ID(pltAbstractObj)))
		{			
			GBEngine_RegisterInterpunctionKeyEx(Global_GetEnineInstance(), GBKEY_0, GBIME_MULTITAP_SYMBOLS_0, 0, GBCL_MULTITAP, 1, 2, 0);	
		} 
		else
		{
			// 0¼ü±íÇé
			PT_ConvertFaceString(pltAbstractObj->pFaceString, facesTable_0,iFacesTableSize);
			GBEngine_RegisterInterpunctionKeyEx(Global_GetEnineInstance(), 
				GBKEY_0, 
				(GBLPCWCHAR)pltAbstractObj->pFaceString, 
				GBIME_SPLIT_CHAR, 
				GBCL_MULTITAP, 
				GBIME_SYMBOL_0_ROW_NUM, 
				iFacesTableSize, 
				GBIKO_Input_Status_Confirm_Candidate);
		}		
	} 
	else
	{
		// 1¼ü·ûºÅ
		PT_ConvertFaceString(pltAbstractObj->pSymbolEnglishString, symbolsTable_1_Alp, iAlpSymbolsTableSize);
		GBEngine_RegisterInterpunctionKeyEx(Global_GetEnineInstance(), 
											GBKEY_1, 
											(GBLPCWCHAR)pltAbstractObj->pSymbolEnglishString, 
											GBIME_SPLIT_CHAR, 
											GBCL_MULTITAP, 
											GBIME_SYMBOL_1_ROW_NUM, 
											iAlpSymbolsTableSize, 
											GBIKO_Input_Status_Confirm_Candidate);

		// ÎïÀíLayout 0¼ü³öÀ´»Ø³µ¡¢¿Õ¸ñ
		if (IS_KB_LAYOUT(GET_LAYOUT_ID(pltAbstractObj)))
		{			
			GBEngine_RegisterInterpunctionKeyEx(Global_GetEnineInstance(), GBKEY_0, GBIME_MULTITAP_SYMBOLS_0, 0, GBCL_MULTITAP, 1, 2, 0);	
		} 
		else // ÐéÄâ¼üÅÌ0¼ü±íÇé
		{			
			PT_ConvertFaceString(pltAbstractObj->pFaceString, facesTable_0, iFacesTableSize);
			GBEngine_RegisterInterpunctionKeyEx(Global_GetEnineInstance(), 
												GBKEY_0, 
												(GBLPCWCHAR)pltAbstractObj->pFaceString, 
												GBIME_SPLIT_CHAR, 
												GBCL_MULTITAP, 
												GBIME_SYMBOL_0_ROW_NUM, 
												iFacesTableSize, 
												GBIKO_Input_Status_Confirm_Candidate);
		}
	}

	return GBIME_OK;
}

/*!
 * \brief Æ½Ì¨Ä³Ð©ÊäÈëÄ£Ê½ÐèÒª½ûÓÃÄ³Ð©¹¦ÄÜ°´Å¥(Èç: ¿ìËÙ²éÕÒÄ£Ê½½ûÖ¹ÊäÈëÖÐÎÄ)
 * \param pltObj 
 * \return 
 * \note 
 *\example
 * \author weizhiping
 * \date 2010-12-30 13:45:08
 */
GBIMELOCAL GBIMEReturn CLayoutAbstract_DisableFuncKeyHandler(GBLPVOID pltObj)
{
	PCLayoutAbstract pltAbstractObj = (PCLayoutAbstract)pltObj;
	PLayoutInfo pLayoutInfo = (PLayoutInfo)(&pltAbstractObj->m_ltData); // Layout UI data point
	KEYBOARD_TYPE keyboardType = GBConfig_GetKeyboardType(Global_GetConfigInstance());

	// ¸ù¾ÝÆ½Ì¨ÊäÈë¿òÊÇ·ñ´¦ÓÚ¿ìËÙ²éÕÒÊäÈëÄ£Ê½¾ö¶¨ÊÇ·ñ½ûÓÃÄ³Ð©¹¦ÄÜ°´Å¥	
	if (GBInputBox_IsQuickSearchInputMode())
	{
		switch (keyboardType)
		{
		case KEYBOARD_VK_NUMPAD:
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_PINYIN, ButtonStatusGray);		///<ÊúÆÁ9¼üÆ´Òô
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_ENG_LOWER, ButtonStatusGray);	///<ÊúÆÁ9¼üÐ¡Ð´Ó¢ÎÄ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_NUM, ButtonStatusGray);		///<ÊúÆÁ9¼üÊý×Ö
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_SYM, ButtonStatusGray);		///<ÊúÆÁ9¼ü·ûºÅ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_FS_HANDWRITE, ButtonStatusGray);///<ÊúÆÁÈ«ÆÁÊÖÐ´
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_BACKWORD, ButtonStatusGray);
			break;
		case KEYBOARD_VK_QWERTY:
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_CAP, ButtonStatusGray);           ///<´óÐ¡Ð´ÇÐ»»¼ü
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V26_PINYIN, ButtonStatusGray);	///<ÊúÆÁ9¼üÆ´Òô
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V26_ENG_LOWER, ButtonStatusGray);	///<ÊúÆÁ9¼üÐ¡Ð´Ó¢ÎÄ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_NUM, ButtonStatusGray);		///<ÊúÆÁ9¼üÊý×Ö
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_SYM, ButtonStatusGray);		///<ÊúÆÁ9¼ü·ûºÅ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_FS_HANDWRITE, ButtonStatusGray);///<ÊúÆÁÈ«ÆÁÊÖÐ´
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_BACKWORD, ButtonStatusGray);
		default: // ÆäËû¼üÅÌ²»Ö§³Ö
			break;
		}

		// ½ûÖ¹»¬ÆÁÇÐ»»
		pltAbstractObj->isSlidingDisabled = GBTrue;
	}
	else
	{
		switch (keyboardType)
		{
		case KEYBOARD_VK_NUMPAD:				
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_PINYIN, ButtonStatusNomal);	///<ÊúÆÁ9¼üÆ´Òô
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_ENG_LOWER, ButtonStatusNomal);	///<ÊúÆÁ9¼üÐ¡Ð´Ó¢ÎÄ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_NUM, ButtonStatusNomal);		///<ÊúÆÁ9¼üÊý×Ö
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_SYM, ButtonStatusNomal);		///<ÊúÆÁ9¼ü·ûºÅ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_FS_HANDWRITE, ButtonStatusNomal);///<ÊúÆÁÈ«ÆÁÊÖÐ´
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_BACKWORD, ButtonStatusNomal);
			break;
		case KEYBOARD_VK_QWERTY:
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_CAP, ButtonStatusNomal);          ///<´óÐ¡Ð´ÇÐ»»¼ü
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V26_PINYIN, ButtonStatusNomal);	///<ÊúÆÁ9¼üÆ´Òô
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V26_ENG_LOWER, ButtonStatusNomal);///<ÊúÆÁ9¼üÐ¡Ð´Ó¢ÎÄ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_NUM, ButtonStatusNomal);		///<ÊúÆÁ9¼üÊý×Ö
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_SYM, ButtonStatusNomal);		///<ÊúÆÁ9¼ü·ûºÅ
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_V9_FS_HANDWRITE, ButtonStatusNomal);///<ÊúÆÁÈ«ÆÁÊÖÐ´
			CLayoutInfo_SetButtonStatus(pLayoutInfo, GBKEY_VK_BACKWORD, ButtonStatusNomal);
		default: // ÆäËû¼üÅÌ²»Ö§³Ö
			break;
		}

		// ÔÊÐí»¬ÆÁÇÐ»»
		pltAbstractObj->isSlidingDisabled = GBFalse;
	}
}